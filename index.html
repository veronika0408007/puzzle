<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–∞–∑–ª</title>
<style>
  body {
    font-family: Arial, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    margin: 0;
    min-height: 100vh;
    background: #f5f5f5;
  }

  #controls {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 20px;
    align-items: center;
  }

  #puzzle {
    display: grid;
    gap: 2px;
    border: 2px solid #000;
    padding: 5px;
    touch-action: none;
    background: #fafafa;
    z-index: 1;
  }

  .cell {
    position: relative;
    overflow: hidden;
    background: #eee;
  }

  .piece {
    width: 100%;
    height: 100%;
    background-size: cover;
    cursor: grab;
    user-select: none;
    transition: transform 150ms ease, border-color 120ms;
    box-sizing: border-box;
    border: 2px solid transparent;
  }

  .piece.dragging {
    opacity: 0.6;
    cursor: grabbing;
    transform: scale(1.02);
    z-index: 10;
  }

  .piece.selected {
    outline: 3px dashed #666;
  }

  #message {
    margin-top: 12px;
    font-weight: bold;
  }

  #previewContainer {
    margin-top: 15px;
    display: none;
    text-align: center;
    z-index: 1;
  }

  #previewPuzzle {
    display: grid;
    gap: 2px;
    border: 2px solid #444;
    padding: 5px;
    background: #fff;
  }

  .previewPiece {
    width: 100%;
    height: 100%;
    background-size: cover;
    box-sizing: border-box;
    border: 2px solid #44444a;
  }

  .cell.drop-target {
    box-shadow: inset 0 0 0 3px rgba(0, 120, 215, 0.25);
  }

  /* Overlay modal for congratulations */
  #overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.55);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    padding: 20px;
  }

  #overlay .modal {
    background: #fff;
    padding: 22px;
    border-radius: 8px;
    max-width: 90%;
    width: 420px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  }

  #overlay .modal h2 {
    margin: 6px 0 12px;
    font-size: 1.25rem;
  }

  #overlay .modal p {
    margin: 8px 0 16px;
  }

  #overlay .modal .actions {
    display:flex;
    gap: 8px;
    justify-content: center;
  }

  button {
    cursor: pointer;
  }

  @media (max-width: 520px) {
    #controls { gap: 6px; }
    .modal { width: 95%; padding: 14px; }
  }
</style>
</head>

<body>

<h1>–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–∞–∑–ª</h1>

<div id="controls">
  <input type="file" id="imageUpload" accept="image/*">
  <label>–®–∏—Ä–∏–Ω–∞:
    <input type="number" id="cols" min="1" max="20" value="5" style="width:60px">
  </label>
  <label>–í—ã—Å–æ—Ç–∞:
    <input type="number" id="rows" min="1" max="20" value="6" style="width:60px">
  </label>
  <label>
    <input type="checkbox" id="enableCheck" checked>
    –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–∑–∏—Ü–∏–∏ –¥–µ—Ç–∞–ª–µ–π
  </label>
  <button id="generate">–°–æ–∑–¥–∞—Ç—å –ø–∞–∑–ª</button>
  <button id="shuffleBtn" disabled>–ü–µ—Ä–µ–º–µ—à–∞—Ç—å</button>
  <button id="previewBtn">–ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É</button>
</div>

<div id="previewContainer">
  <h3>–ö–∞–∫ –¥–æ–ª–∂–Ω–æ –≤—ã–≥–ª—è–¥–µ—Ç—å:</h3>
  <div id="previewPuzzle"></div>
</div>

<div id="puzzle" aria-label="–ü–æ–ª–µ –ø–∞–∑–ª–∞"></div>
<div id="message" aria-live="polite"></div>
<h3 id="timer">–í—Ä–µ–º—è: 0:00:000 </h3>

<!-- Overlay modal -->
<div id="overlay" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal" role="document">
    <h2 id="overlayTitle">–£—Ä–∞! –ü–∞–∑–ª —Å–æ–±—Ä–∞–Ω üéâ</h2>
    <p id="overlayTime">–í—Ä–µ–º—è: 0:00:000</p>
    <div class="actions">
      <button id="overlayOk">–û–ö</button>
      <button id="overlayShuffle">–ü–µ—Ä–µ–º–µ—à–∞—Ç—å</button>
    </div>
  </div>
</div>

<script>
  const imgInput = document.getElementById('imageUpload');
  const generateBtn = document.getElementById('generate');
  const shuffleBtn = document.getElementById('shuffleBtn');
  const previewBtn = document.getElementById('previewBtn');
  const enableCheck = document.getElementById('enableCheck');
  const puzzle = document.getElementById('puzzle');
  const previewContainer = document.getElementById('previewContainer');
  const previewPuzzle = document.getElementById('previewPuzzle');
  const message = document.getElementById('message');
  const timerDisplay = document.getElementById('timer');

  const overlay = document.getElementById('overlay');
  const overlayTime = document.getElementById('overlayTime');
  const overlayOk = document.getElementById('overlayOk');
  const overlayShuffle = document.getElementById('overlayShuffle');

  let imageURL = '';
  let cols = 5, rows = 6;
  let pieceWidth = 100, pieceHeight = 100;
  let cells = [];
  let started = false;
  let startTime = null;
  let timer = null;
  let pieceIdCounter = 0;
  let solvedAlready = false; // prevent multiple overlays

  /* ===== –ó–ê–ì–†–£–ó–ö–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø ===== */
  imgInput.addEventListener('change', e => {
    if (e.target.files && e.target.files[0]) {
      imageURL = URL.createObjectURL(e.target.files[0]);
    }
  });

  /* ===== –°–û–ó–î–ê–ù–ò–ï –ü–ê–ó–õ–ê ===== */
  generateBtn.addEventListener('click', () => {
    if (!imageURL) return alert('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');

    cols = Math.max(1, Math.min(20, +document.getElementById('cols').value || 1));
    rows = Math.max(1, Math.min(20, +document.getElementById('rows').value || 1));

    const canvasSize = 500;
    pieceWidth = Math.floor(canvasSize / cols);
    pieceHeight = Math.floor(canvasSize / rows);

    puzzle.innerHTML = '';
    cells = [];
    pieceIdCounter = 0;
    solvedAlready = false;

    puzzle.style.display = 'grid';
    puzzle.style.gridTemplateColumns = `repeat(${cols}, ${pieceWidth}px)`;
    puzzle.style.gridTemplateRows = `repeat(${rows}, ${pieceHeight}px)`;

    for (let i = 0; i < cols * rows; i++) {
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.style.width = pieceWidth + 'px';
      cell.style.height = pieceHeight + 'px';
      cell.dataset.index = i;

      cell.addEventListener('dragover', e => {
        e.preventDefault();
        cell.classList.add('drop-target');
      });
      cell.addEventListener('dragleave', () => cell.classList.remove('drop-target'));
      cell.addEventListener('drop', onDropOnCell);

      const piece = document.createElement('div');
      piece.className = 'piece';
      piece.draggable = true;
      piece.id = 'piece-' + (pieceIdCounter++);

      const r = Math.floor(i / cols);
      const c = i % cols;

      piece.style.backgroundImage = `url(${imageURL})`;
      piece.style.backgroundSize = `${cols * pieceWidth}px ${rows * pieceHeight}px`;
      piece.style.backgroundPosition = `-${c * pieceWidth}px -${r * pieceHeight}px`;
      piece.dataset.correct = i;

      piece.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/plain', piece.id);
        piece.classList.add('dragging');
        if (!started) startTimer();
      });
      piece.addEventListener('dragend', () => {
        piece.classList.remove('dragging');
        document.querySelectorAll('.cell.drop-target').forEach(el => el.classList.remove('drop-target'));
      });

      piece.addEventListener('click', e => {
        e.stopPropagation();
        toggleSelect(piece);
      });

      piece.addEventListener('touchstart', onTouchStart, {passive:false});
      piece.addEventListener('touchmove', onTouchMove, {passive:false});
      piece.addEventListener('touchend', onTouchEnd);

      cell.appendChild(piece);
      cells.push(cell);
      puzzle.appendChild(cell);
    }

    shuffle();
    shuffleBtn.disabled = false;
    resetTimer();
    message.textContent = '';
  });

  /* ===== –ü–ï–†–ï–ú–ï–®–ò–í–ê–ù–ò–ï ===== */
  shuffleBtn.addEventListener('click', () => {
    shuffle();
    solvedAlready = false;
    hideOverlay();
    resetTimer();
    message.textContent = '';
  });

  function shuffle() {
    const pieces = cells.map(c => c.firstChild);
    // Fisher-Yates
    for (let i = pieces.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [pieces[i], pieces[j]] = [pieces[j], pieces[i]];
    }
    cells.forEach((cell, i) => cell.appendChild(pieces[i]));
    document.querySelectorAll('.piece').forEach(p => p.style.border = '2px solid transparent');
    message.textContent = '';
  }

  /* ===== DROP –Ω–∞ —è—á–µ–π–∫—É ===== */
  function onDropOnCell(e) {
    e.preventDefault();
    this.classList.remove('drop-target');
    const draggedId = e.dataTransfer.getData('text/plain');
    const dragged = document.getElementById(draggedId);
    if (!dragged) return;

    const targetPiece = this.firstChild;
    const sourceCell = dragged.parentElement;

    if (sourceCell === this) return;

    sourceCell.appendChild(targetPiece);
    this.appendChild(dragged);

    dragged.classList.remove('selected', 'dragging');

    // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∫–ª—é—á–∏–ª –ø—Ä–æ–≤–µ—Ä–∫—É ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –∏ –≤—ã–∑—ã–≤–∞–µ–º overlay –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
    if (enableCheck.checked) checkPositions();
    else if (isSolved()) finishPuzzle();
  }

  /* ===== –í–´–î–ï–õ–ï–ù–ò–ï –ö–õ–ò–ö–û–ú ===== */
  let selectedPiece = null;
  function toggleSelect(piece) {
    if (selectedPiece) selectedPiece.classList.remove('selected');
    if (selectedPiece === piece) {
      selectedPiece = null;
    } else {
      selectedPiece = piece;
      piece.classList.add('selected');
    }
    if (!started && selectedPiece) startTimer();
  }

  /* ===== –ö–õ–ò–ö –ü–û –Ø–ß–ï–ô–ö–ï (–æ–±–º–µ–Ω) ===== */
  puzzle.addEventListener('click', e => {
    const cell = e.target.closest('.cell');
    if (!cell || !selectedPiece) return;

    const targetPiece = cell.firstChild;
    const sourceCell = selectedPiece.parentElement;

    if (targetPiece === selectedPiece) return;

    sourceCell.appendChild(targetPiece);
    cell.appendChild(selectedPiece);

    selectedPiece.classList.remove('selected');
    selectedPiece = null;

    if (enableCheck.checked) checkPositions();
    else if (isSolved()) finishPuzzle();
  });

  /* ===== –ü–†–û–í–ï–†–ö–ê ===== */
  function checkPositions() {
    let solved = true;

    cells.forEach((cell, i) => {
      const piece = cell.firstChild;
      if (+piece.dataset.correct === i) {
        piece.style.border = '2px solid green';
      } else {
        piece.style.border = '2px solid red';
        solved = false;
      }
    });

    if (solved) finishPuzzle();
  }

  function isSolved() {
    return cells.every((cell, i) =>
      +cell.firstChild.dataset.correct === i
    );
  }

  /* ===== –§–ò–ù–ò–® (–ø–æ–∫–∞–∑ overlay) ===== */
  function finishPuzzle() {
    if (solvedAlready) return;
    solvedAlready = true;

    stopTimer();
    message.textContent = '–ü–∞–∑–ª —Å–æ–±—Ä–∞–Ω! üéâ';

    // –ü–æ–∫–∞–∑–∞—Ç—å overlay —Å –∏—Ç–æ–≥–æ–≤—ã–º –≤—Ä–µ–º–µ–Ω–µ–º
    const formatted = formatElapsedTime();
    overlayTime.textContent = `–í—Ä–µ–º—è: ${formatted}`;
    showOverlay();
  }

  /* ===== –ü–æ–∫–∞–∑ / —Å–∫—Ä—ã—Ç–∏–µ overlay ===== */
  function showOverlay() {
    overlay.style.display = 'flex';
    overlay.setAttribute('aria-hidden', 'false');
    // –±–ª–æ–∫–∏—Ä—É–µ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –ø–∞–∑–ª–æ–º (overlay –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç –≤—Å—ë)
    document.body.style.overflow = 'hidden';
  }

  function hideOverlay() {
    overlay.style.display = 'none';
    overlay.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
  }

  overlayOk.addEventListener('click', () => {
    hideOverlay();
  });

  overlayShuffle.addEventListener('click', () => {
    hideOverlay();
    shuffle();
    resetTimer();
    solvedAlready = false;
    message.textContent = '';
  });

  /* ===== –¢–ê–ô–ú–ï–† ===== */
  function startTimer() {
    if (started) return;
    started = true;
    startTime = performance.now();

    timer = setInterval(() => {
      const t = performance.now() - startTime;
      const ms = Math.floor(t % 1000).toString().padStart(3, '0');
      const sec = Math.floor(t / 1000) % 60;
      const min = Math.floor(t / 60000);

      timerDisplay.textContent =
        `–í—Ä–µ–º—è: ${min}:${sec.toString().padStart(2,'0')}:${ms}`;
    }, 50);
  }

  function stopTimer() {
    clearInterval(timer);
  }

  function resetTimer() {
    clearInterval(timer);
    started = false;
    startTime = null;
    timerDisplay.textContent = '–í—Ä–µ–º—è: 0:00:000';
  }

  function formatElapsedTime() {
    if (!startTime) return '0:00:000';
    const t = performance.now() - startTime;
    const ms = Math.floor(t % 1000).toString().padStart(3, '0');
    const sec = Math.floor(t / 1000) % 60;
    const min = Math.floor(t / 60000);
    return `${min}:${sec.toString().padStart(2,'0')}:${ms}`;
  }

  /* ===== –ü–†–ï–í–¨–Æ ‚Äî –¢–ê–ö –ñ–ï, –ö–ê–ö –ü–ê–ó–õ (–°–ë–û–†–ö–ê) ===== */
  previewBtn.addEventListener('click', () => {
    if (!imageURL) return alert('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');

    // Toggle visibility
    if (previewContainer.style.display === 'block') {
      previewContainer.style.display = 'none';
      previewBtn.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É';
      return;
    }

    const useCols = cols || Math.max(1, +document.getElementById('cols').value || 1);
    const useRows = rows || Math.max(1, +document.getElementById('rows').value || 1);
    const canvasSize = 500;
    const pW = Math.floor(canvasSize / useCols);
    const pH = Math.floor(canvasSize / useRows);

    previewPuzzle.innerHTML = '';
    previewPuzzle.style.gridTemplateColumns = `repeat(${useCols}, ${pW}px)`;
    previewPuzzle.style.gridTemplateRows = `repeat(${useRows}, ${pH}px)`;

    for (let i = 0; i < useCols * useRows; i++) {
      const r = Math.floor(i / useCols);
      const c = i % useCols;

      const pp = document.createElement('div');
      pp.className = 'previewPiece';
      pp.style.width = pW + 'px';
      pp.style.height = pH + 'px';
      pp.style.backgroundImage = `url(${imageURL})`;
      pp.style.backgroundSize = `${useCols * pW}px ${useRows * pH}px`;
      pp.style.backgroundPosition = `-${c * pW}px -${r * pH}px`;
      previewPuzzle.appendChild(pp);
    }

    previewContainer.style.display = 'block';
    previewBtn.textContent = '–°–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É';
  });

  /* ===== TOUCH-DRAG SUPPORT (–¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö) ===== */
  let touchDrag = {
    piece: null,
    srcCell: null,
    currentTargetCell: null
  };

  function onTouchStart(e) {
    e.preventDefault();
    const piece = e.currentTarget;
    touchDrag.piece = piece;
    touchDrag.srcCell = piece.parentElement;
    piece.classList.add('dragging');
    if (!started) startTimer();
  }

  function onTouchMove(e) {
    if (!touchDrag.piece) return;
    e.preventDefault();
    const touch = e.changedTouches[0];
    const el = document.elementFromPoint(touch.clientX, touch.clientY);
    const cell = el ? el.closest('.cell') : null;
    if (cell !== touchDrag.currentTargetCell) {
      if (touchDrag.currentTargetCell) touchDrag.currentTargetCell.classList.remove('drop-target');
      touchDrag.currentTargetCell = cell;
      if (cell) cell.classList.add('drop-target');
    }
  }

  function onTouchEnd(e) {
    if (!touchDrag.piece) return;
    const piece = touchDrag.piece;
    const targetCell = touchDrag.currentTargetCell;
    piece.classList.remove('dragging');

    if (targetCell && targetCell !== touchDrag.srcCell) {
      const targetPiece = targetCell.firstChild;
      const srcCell = touchDrag.srcCell;

      srcCell.appendChild(targetPiece);
      targetCell.appendChild(piece);

      if (enableCheck.checked) checkPositions();
      else if (isSolved()) finishPuzzle();
    }

    document.querySelectorAll('.cell.drop-target').forEach(el => el.classList.remove('drop-target'));

    touchDrag.piece = null;
    touchDrag.srcCell = null;
    touchDrag.currentTargetCell = null;
  }

  // Hide overlay if user presses Escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && overlay.style.display === 'flex') {
      hideOverlay();
    }
  });

  // Initial small hint
  message.textContent = '–°–æ–∑–¥–∞–π—Ç–µ –ø–∞–∑–ª, –∑–∞—Ç–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –∏–ª–∏ –∫–ª–∏–∫–∞–π—Ç–µ –¥–µ—Ç–∞–ª–∏ –¥–ª—è –æ–±–º–µ–Ω–∞. –ú–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å/–æ—Ç–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É.';
</script>

</body>
</html>
