<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–∞–∑–ª ‚Äî —Å –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏</title>
<style>
:root { --card-bg:#fff; --accent:#2196f3; --muted:#666; --danger:#e53935; }
body{
  font-family:Arial,Helvetica,sans-serif;
  margin:0;
  padding:18px;
  background:#f5f5f5;
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  color:#222;
}
header{ width:100%; max-width:1100px; display:flex; gap:12px; align-items:center; margin-bottom:12px; }
h1{ margin:0; font-size:1.15rem; }
#topControls{ margin-left:auto; display:flex; gap:8px; align-items:center; }
.btn{ padding:8px 12px; border-radius:6px; border:1px solid #ddd; background:var(--card-bg); cursor:pointer; font-size:0.95rem; }
.btn.primary{ background:var(--accent); color:#fff; border-color:#1976d2; }
.btn.ghost{ background:transparent; border:1px solid transparent; }
main{ width:100%; max-width:1100px; display:flex; gap:14px; align-items:flex-start; }

/* puzzle area */
#puzzleArea{ flex:1; display:flex; gap:14px; flex-direction:column; align-items:flex-start; }
#controls{ width:100%; background:var(--card-bg); padding:10px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.06); display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
#puzzle{ display:grid; gap:2px; border:2px solid #000; padding:5px; background:#fafafa; touch-action:none; }
.cell{ position:relative; overflow:hidden; background:#eee; }
.piece{ width:100%; height:100%; background-size:cover; cursor:grab; user-select:none; transition:transform 150ms ease, border-color 120ms; box-sizing:border-box; border:2px solid transparent; }
.piece.dragging{ opacity:0.6; cursor:grabbing; transform:scale(1.02); z-index:10; }
.piece.selected{ outline:3px dashed #666; }
.cell.drop-target{ box-shadow:inset 0 0 0 3px rgba(0,120,215,0.18); }

#previewContainer{ display:none; margin-top:8px; }
#previewPuzzle{ display:grid; gap:2px; border:2px solid #444; padding:5px; background:#fff; }
.previewPiece{ box-sizing:border-box; border:2px solid #44444a; width:100%; height:100%; background-size:cover; }

#message{ margin-top:8px; color:var(--muted); font-size:0.95rem; }
#timer{ margin:6px 0 0 0; font-size:1rem; color:#222; }

/* Overlays */
.overlay {
  position:fixed; inset:0; display:none; background:rgba(0,0,0,0.45);
  align-items:center; justify-content:center; z-index:2100; padding:18px;
}
.panel { width:760px; max-width:95%; background:var(--card-bg); border-radius:8px; padding:14px; box-shadow:0 10px 40px rgba(0,0,0,0.2); }
.panel.small{ width:420px; max-width:92%; }

/* menu layout inside overlay */
.menu { display:flex; gap:12px; align-items:flex-start; }
.menuSidebar{ width:240px; }
#presetList{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.presetItem{ border:2px solid transparent; border-radius:6px; overflow:hidden; cursor:pointer; background:#f6f6f6; }
.presetItem.selected{ border-color:var(--accent); box-shadow:0 6px 18px rgba(33,150,243,0.12); }
.presetItem img{ display:block; width:100%; height:84px; object-fit:cover; }
.menuRight{ flex:1; display:flex; flex-direction:column; gap:10px; }

/* completion overlay */
.completeActions{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:8px; }

/* account panel */
.account-tabs{ display:flex; gap:8px; margin-bottom:10px; }
.tab{ padding:8px 12px; border-radius:6px; background:#f3f3f3; cursor:pointer; border:1px solid #e6e6e6; }
.tab.active{ background:var(--accent); color:#fff; border-color:#1976d2; }

.form-row{ display:flex; flex-direction:column; gap:6px; margin-bottom:8px; }
.form-row.inline{ flex-direction:row; align-items:center; gap:8px; }
.input{ padding:8px; border:1px solid #ccc; border-radius:6px; width:100%; box-sizing:border-box; }

/* stats table */
.statsTable{ width:100%; border-collapse:collapse; margin-top:8px; font-size:0.95rem; }
.statsTable th, .statsTable td{ padding:6px 8px; border-bottom:1px solid #eee; text-align:left; }

/* small screens */
@media (max-width:800px) {
  .menu{ flex-direction:column; }
  .menuSidebar{ width:100%; }
  header, main{ padding:0 12px; }
}
</style>
</head>
<body>

<header>
  <h1>–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–∞–∑–ª</h1>
  <div id="topControls">
    <button id="menuToggleBtn" class="btn">–ú–µ–Ω—é</button>
    <button id="previewBtn" class="btn">–ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É</button>
    <button id="shuffleBtn" class="btn" disabled>–ü–µ—Ä–µ–º–µ—à–∞—Ç—å</button>
    <button id="accountBtn" class="btn">–ê–∫–∫–∞—É–Ω—Ç</button>
  </div>
</header>

<main>
  <div id="puzzleArea">
    <div id="controls" aria-label="–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è">
      <input type="file" id="imageUpload" accept="image/*" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ—é –∫–∞—Ä—Ç–∏–Ω–∫—É">
      <label style="display:flex;align-items:center;gap:6px;">
        <input type="checkbox" id="enableCheck" checked> –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–∑–∏—Ü–∏–∏
      </label>
      <div style="margin-left:auto;color:#666;font-size:0.95rem;">–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –ø–ª–∏—Ç–∫–∏ –∏–ª–∏ –∫–ª–∏–∫–∞–π—Ç–µ —á—Ç–æ–±—ã –æ–±–º–µ–Ω—è—Ç—å</div>
    </div>

    <div id="puzzle" aria-label="–ü–æ–ª–µ –ø–∞–∑–ª–∞"></div>

    <div id="previewContainer" aria-hidden="true">
      <h3 style="margin:8px 0 6px;">–ö–∞–∫ –¥–æ–ª–∂–Ω–æ –≤—ã–≥–ª—è–¥–µ—Ç—å:</h3>
      <div id="previewPuzzle"></div>
    </div>

    <div id="message" aria-live="polite">–ù–∞–∂–º–∏—Ç–µ "–ú–µ–Ω—é" –≤–≤–µ—Ä—Ö—É, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É –∏ —Ä–∞–∑–º–µ—Ä. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.</div>
    <h3 id="timer">–í—Ä–µ–º—è: 0:00:000</h3>
  </div>
</main>

<!-- Menu overlay (select image & size) -->
<div id="menuOverlay" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="panel menu" role="document" aria-label="–ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∏ —Ä–∞–∑–º–µ—Ä–∞">
    <div class="menuSidebar">
      <h3 style="margin:0 0 8px 0;">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É</h3>
      <div id="presetList"></div>
      <div style="margin-top:10px;">
        <label style="font-size:0.9rem;">–ò–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–≤–æ—é</label>
        <input type="file" id="menuUpload" accept="image/*" style="width:100%;margin-top:6px;">
      </div>
    </div>

    <div class="menuRight">
      <h3 style="margin:0;">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ä</h3>
      <div class="presetSizes" id="presetSizes">
        <button data-cols="3" data-rows="3" class="btn">3 √ó 3</button>
        <button data-cols="5" data-rows="6" class="btn primary">5 √ó 6</button>
        <button data-cols="8" data-rows="6" class="btn">8 √ó 6</button>
        <button data-cols="10" data-rows="8" class="btn">10 √ó 8</button>
      </div>

      <div style="display:flex;gap:8px;align-items:center;">
        <label>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π:
          <input type="number" id="menuCols" min="1" max="30" value="5" style="width:70px;margin-left:6px">
          √ó
          <input type="number" id="menuRows" min="1" max="30" value="6" style="width:70px;margin-left:6px">
        </label>
      </div>

      <div style="display:flex;gap:8px;margin-top:auto;">
        <button id="menuCreate" class="btn primary">–°–æ–∑–¥–∞—Ç—å –ø–∞–∑–ª</button>
        <button id="menuUseUploaded" class="btn">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ</button>
        <button id="menuClose" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div style="color:#666;font-size:0.9rem;margin-top:6px;">–ú–µ–Ω—é –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ–≤–µ—Ä—Ö —Å—Ç—Ä–∞–Ω–∏—Ü—ã; –Ω–∞–∂–º–∏—Ç–µ ¬´–ú–µ–Ω—é¬ª –µ—â—ë —Ä–∞–∑ —á—Ç–æ–±—ã –∑–∞–∫—Ä—ã—Ç—å.</div>
    </div>
  </div>
</div>

<!-- Completion overlay -->
<div id="completeOverlay" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="panel small" role="document">
    <h2>–£—Ä–∞! –ü–∞–∑–ª —Å–æ–±—Ä–∞–Ω üéâ</h2>
    <p id="completeTime">–í—Ä–µ–º—è: 0:00:000</p>
    <div class="completeActions">
      <button id="completeShuffle" class="btn">–ü–µ—Ä–µ–º–µ—à–∞—Ç—å</button>
      <button id="completeNew" class="btn primary">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–∞–∑–ª</button>
      <button id="completeClose" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div style="margin-top:10px; font-size:0.95rem; color:#444;">
      –†–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –≤–∞—à–µ–º –ø—Ä–æ—Ñ–∏–ª–µ, –µ—Å–ª–∏ –≤—ã –≤–æ—à–ª–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç.
    </div>
  </div>
</div>

<!-- Account overlay -->
<div id="accountOverlay" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="panel small" role="document">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3 style="margin:0;">–ê–∫–∫–∞—É–Ω—Ç</h3>
      <button id="accountClose" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div class="account-tabs" role="tablist" aria-label="–ê–∫–∫–∞—É–Ω—Ç">
      <div id="tabLogin" class="tab active" role="tab">–í–æ–π—Ç–∏</div>
      <div id="tabRegister" class="tab" role="tab">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
      <div id="tabProfile" class="tab" role="tab">–ü—Ä–æ—Ñ–∏–ª—å</div>
      <div id="tabStats" class="tab" role="tab">–ú–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</div>
    </div>

    <div id="accountContent">
      <!-- Login -->
      <div id="paneLogin">
        <div class="form-row">
          <label>–ü–æ—á—Ç–∞</label>
          <input id="loginEmail" class="input" type="email" autocomplete="email">
        </div>
        <div class="form-row">
          <label>–ü–∞—Ä–æ–ª—å</label>
          <input id="loginPassword" class="input" type="password" autocomplete="current-password">
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button id="loginBtn" class="btn primary">–í–æ–π—Ç–∏</button>
          <button id="goToRegister" class="btn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>
        <div id="loginMsg" style="margin-top:8px;color:var(--muted)"></div>
      </div>

      <!-- Register -->
      <div id="paneRegister" style="display:none;">
        <div class="form-row">
          <label>–ü–æ—á—Ç–∞</label>
          <input id="regEmail" class="input" type="email" autocomplete="email">
        </div>
        <div class="form-row">
          <label>–ù–∏–∫–Ω–µ–π–º</label>
          <input id="regNick" class="input" type="text" maxlength="30">
        </div>
        <div class="form-row inline">
          <div style="flex:1;">
            <label>–í–æ–∑—Ä–∞—Å—Ç</label>
            <input id="regAge" class="input" type="number" min="1" max="120">
          </div>
          <div style="flex:1;">
            <label>–ü–∞—Ä–æ–ª—å</label>
            <input id="regPassword" class="input" type="password" autocomplete="new-password">
          </div>
        </div>
        <div class="form-row">
          <label>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
          <input id="regPassword2" class="input" type="password">
        </div>
        <div style="display:flex;gap:8px;">
          <button id="regBtn" class="btn primary">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
          <button id="regCancel" class="btn">–û—Ç–º–µ–Ω–∞</button>
        </div>
        <div id="regMsg" style="margin-top:8px;color:var(--muted)"></div>
      </div>

      <!-- Profile -->
      <div id="paneProfile" style="display:none;">
        <div id="profileInfo" style="margin-bottom:8px;color:var(--muted)"></div>
        <div style="display:flex;gap:8px;">
          <button id="logoutBtn" class="btn">–í—ã–π—Ç–∏</button>
          <button id="resendConfirmBtn" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–¥–µ–º–æ)</button>
        </div>
        <div style="margin-top:8px;color:var(--muted);" id="profileMsg"></div>
      </div>

      <!-- Stats -->
      <div id="paneStats" style="display:none;">
        <div id="statsSummary" style="color:var(--muted)"></div>
        <table class="statsTable" id="statsTable">
          <thead><tr><th>–ö–∞—Ä—Ç–∏–Ω–∫–∞</th><th>–†–∞–∑–º–µ—Ä</th><th>–í—Ä–µ–º—è</th><th>–î–∞—Ç–∞</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
/*
  Client-side "accounts" system (demo-only):
  - Users stored in localStorage (no real emails).
  - Passwords hashed with SHA-256 before storing.
  - Registration creates a confirmation code (shown to user in UI as "demo email").
  - After confirming, user can login; solved puzzle times are saved to user's profile.
  - This is a demo/local-only approach ‚Äî for production you'd use a backend and real email sending.
*/

/* ========== Utilities ========== */
function $(id){ return document.getElementById(id); }
function formatTime(ms){
  const m = Math.floor(ms / 60000);
  const s = Math.floor(ms / 1000) % 60;
  const msr = Math.floor(ms % 1000).toString().padStart(3,'0');
  return `${m}:${s.toString().padStart(2,'0')}:${msr}`;
}
async function sha256Hex(text){
  const enc = new TextEncoder().encode(text);
  const hash = await crypto.subtle.digest('SHA-256', enc);
  const bytes = Array.from(new Uint8Array(hash));
  return bytes.map(b => b.toString(16).padStart(2,'0')).join('');
}

/* ========== Storage helpers ========== */
const STORAGE_USERS = 'puzzle_users_v1';
const STORAGE_CURRENT = 'puzzle_current_user';

function loadUsers(){
  try{
    const raw = localStorage.getItem(STORAGE_USERS);
    return raw ? JSON.parse(raw) : {};
  }catch(e){ return {}; }
}
function saveUsers(users){ localStorage.setItem(STORAGE_USERS, JSON.stringify(users)); }

function setCurrentUser(email){
  if(email) localStorage.setItem(STORAGE_CURRENT, email); else localStorage.removeItem(STORAGE_CURRENT);
}
function getCurrentUserEmail(){ return localStorage.getItem(STORAGE_CURRENT); }
function getCurrentUser(){
  const email = getCurrentUserEmail(); if(!email) return null;
  const users = loadUsers(); return users[email] || null;
}

/* ========== Presets & Puzzle state ========== */
const presets = [
  { id:'p1', title:'–ì–æ—Ä—ã', url:'https://images.unsplash.com/photo-1501785888041-af3ef285b470?q=80&w=1200&auto=format&fit=crop' },
  { id:'p2', title:'–ì–æ—Ä–æ–¥', url:'https://images.unsplash.com/photo-1491553895911-0055eca6402d?q=80&w=1200&auto=format&fit=crop' },
  { id:'p3', title:'–ü—Ç–∏—Ü–∞', url:'https://images.unsplash.com/photo-1507149833265-60c372daea22?q=80&w=1200&auto=format&fit=crop' },
  { id:'p4', title:'–ê–±—Å—Ç—Ä–∞–∫—Ç', url:'https://images.unsplash.com/photo-1504198453319-5ce911bafcde?q=80&w=1200&auto=format&fit=crop' }
];

let selectedPreset = presets[0];
let uploadedURL = '';
let imageURL = selectedPreset.url;
let imageId = selectedPreset.id; // id for stats (if uploaded -> use uploadedURL)
let cols = 5, rows = 6;
let pieceWidth = 100, pieceHeight = 100;
let cells = [];
let started = false, startTime = null, timer = null;
let pieceIdCounter = 0;
let solvedAlready = false;
let selectedPiece = null;
let currentPuzzleMeta = null; // {imageId,imageURL,cols,rows}

/* ========== DOM refs ========== */
const menuToggleBtn = $('menuToggleBtn');
const menuOverlay = $('menuOverlay');
const presetListEl = $('presetList');
const presetSizesEl = $('presetSizes');
const menuCols = $('menuCols');
const menuRows = $('menuRows');
const menuCreate = $('menuCreate');
const menuUseUploaded = $('menuUseUploaded');
const menuClose = $('menuClose');
const menuUpload = $('menuUpload');

const imageUpload = $('imageUpload');
const previewBtn = $('previewBtn');
const shuffleBtn = $('shuffleBtn');
const enableCheckEl = $('enableCheck');
const puzzleEl = $('puzzle');
const previewContainer = $('previewContainer');
const previewPuzzle = $('previewPuzzle');
const messageEl = $('message');
const timerDisplay = $('timer');

const completeOverlay = $('completeOverlay');
const completeTime = $('completeTime');
const completeShuffle = $('completeShuffle');
const completeNew = $('completeNew');
const completeClose = $('completeClose');

const accountBtn = $('accountBtn');
const accountOverlay = $('accountOverlay');
const accountClose = $('accountClose');
const tabLogin = $('tabLogin');
const tabRegister = $('tabRegister');
const tabProfile = $('tabProfile');
const tabStats = $('tabStats');

const paneLogin = $('paneLogin');
const paneRegister = $('paneRegister');
const paneProfile = $('paneProfile');
const paneStats = $('paneStats');

const loginEmail = $('loginEmail');
const loginPassword = $('loginPassword');
const loginBtn = $('loginBtn');
const loginMsg = $('loginMsg');

const regEmail = $('regEmail');
const regNick = $('regNick');
const regAge = $('regAge');
const regPassword = $('regPassword');
const regPassword2 = $('regPassword2');
const regBtn = $('regBtn');
const regMsg = $('regMsg');

const profileInfo = $('profileInfo');
const profileMsg = $('profileMsg');
const logoutBtn = $('logoutBtn');
const resendConfirmBtn = $('resendConfirmBtn');

const statsSummary = $('statsSummary');
const statsTableBody = $('statsTable').querySelector('tbody');

/* ========== Build presets in menu ========== */
function buildPresetThumbnails(){
  presetListEl.innerHTML = '';
  presets.forEach(p=>{
    const el = document.createElement('div');
    el.className = 'presetItem';
    el.dataset.id = p.id;
    el.innerHTML = `<img src="${p.url}" alt="${p.title}"><div style="padding:6px;font-size:12px;text-align:center;">${p.title}</div>`;
    el.addEventListener('click', ()=>{
      document.querySelectorAll('.presetItem').forEach(i=>i.classList.remove('selected'));
      el.classList.add('selected');
      selectedPreset = p; imageURL = p.url; imageId = p.id;
    });
    presetListEl.appendChild(el);
  });
  // select first
  const first = presetListEl.querySelector('.presetItem');
  if(first){ first.classList.add('selected'); selectedPreset = presets[0]; imageURL = presets[0].url; imageId = presets[0].id; }
}
buildPresetThumbnails();

/* preset sizes */
presetSizesEl.querySelectorAll('button').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    presetSizesEl.querySelectorAll('button').forEach(b=>b.classList.remove('primary'));
    btn.classList.add('primary');
    menuCols.value = btn.dataset.cols;
    menuRows.value = btn.dataset.rows;
  });
});

/* menu toggle */
function openMenu(){ menuOverlay.style.display='flex'; menuOverlay.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
function closeMenu(){ menuOverlay.style.display='none'; menuOverlay.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }
menuToggleBtn.addEventListener('click', ()=>{ if(menuOverlay.style.display==='flex') closeMenu(); else openMenu(); });
menuClose.addEventListener('click', closeMenu);
menuOverlay.addEventListener('click', e=>{ if(e.target===menuOverlay) closeMenu(); });

/* menu uploads */
menuUpload.addEventListener('change', e=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  if(uploadedURL) URL.revokeObjectURL(uploadedURL);
  uploadedURL = URL.createObjectURL(f);
  imageURL = uploadedURL; imageId = 'uploaded:' + uploadedURL;
  // deselect presets
  document.querySelectorAll('.presetItem').forEach(i=>i.classList.remove('selected'));
});

/* quick upload outside menu */
imageUpload.addEventListener('change', e=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  if(uploadedURL) URL.revokeObjectURL(uploadedURL);
  uploadedURL = URL.createObjectURL(f);
  imageURL = uploadedURL; imageId = 'uploaded:' + uploadedURL;
  messageEl.textContent = '–ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –û—Ç–∫—Ä–æ–π—Ç–µ –º–µ–Ω—é –∏ –Ω–∞–∂–º–∏—Ç–µ "–°–æ–∑–¥–∞—Ç—å –ø–∞–∑–ª".';
});

/* menu actions */
menuUseUploaded.addEventListener('click', ()=>{
  if(!uploadedURL) return alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–≤–æ—é –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ –º–µ–Ω—é.');
  imageURL = uploadedURL; imageId = 'uploaded:' + uploadedURL;
  document.querySelectorAll('.presetItem').forEach(i=>i.classList.remove('selected'));
  messageEl.textContent = '–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—ÅÔøΩÔøΩ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞.';
});
menuCreate.addEventListener('click', ()=>{
  const c = Math.max(1, Math.min(30, +menuCols.value || 1));
  const r = Math.max(1, Math.min(30, +menuRows.value || 1));
  if(!imageURL) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ –º–µ–Ω—é.');
  createPuzzle(imageURL, imageId || (selectedPreset && selectedPreset.id) || imageURL, c, r);
  closeMenu();
});

/* ========== Puzzle creation & logic ========== */
function createPuzzle(imgSrc, imgId, c, r){
  cols = c; rows = r;
  const canvasSize = 500;
  pieceWidth = Math.floor(canvasSize / cols);
  pieceHeight = Math.floor(canvasSize / rows);

  puzzleEl.innerHTML = '';
  cells = []; pieceIdCounter = 0; solvedAlready = false; selectedPiece = null;

  puzzleEl.style.gridTemplateColumns = `repeat(${cols}, ${pieceWidth}px)`;
  puzzleEl.style.gridTemplateRows = `repeat(${rows}, ${pieceHeight}px)`;

  for(let i=0;i<cols*rows;i++){
    const cell = document.createElement('div');
    cell.className='cell';
    cell.style.width = pieceWidth + 'px'; cell.style.height = pieceHeight + 'px';
    cell.dataset.index = i;

    cell.addEventListener('dragover', e=>{ e.preventDefault(); cell.classList.add('drop-target'); });
    cell.addEventListener('dragleave', ()=>cell.classList.remove('drop-target'));
    cell.addEventListener('drop', onDropOnCell);

    const piece = document.createElement('div');
    piece.className='piece'; piece.draggable = true; piece.id = 'piece-'+(pieceIdCounter++);
    const rr = Math.floor(i/cols), cc = i%cols;
    piece.style.backgroundImage = `url(${imgSrc})`;
    piece.style.backgroundSize = `${cols*pieceWidth}px ${rows*pieceHeight}px`;
    piece.style.backgroundPosition = `-${cc*pieceWidth}px -${rr*pieceHeight}px`;
    piece.dataset.correct = i;

    piece.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', piece.id); piece.classList.add('dragging'); if(!started) startTimer(); });
    piece.addEventListener('dragend', ()=>{ piece.classList.remove('dragging'); document.querySelectorAll('.cell.drop-target').forEach(el=>el.classList.remove('drop-target')); });

    piece.addEventListener('click', e=>{ e.stopPropagation(); toggleSelect(piece); });

    piece.addEventListener('touchstart', onTouchStart, {passive:false});
    piece.addEventListener('touchmove', onTouchMove, {passive:false});
    piece.addEventListener('touchend', onTouchEnd);

    cell.appendChild(piece);
    cells.push(cell);
    puzzleEl.appendChild(cell);
  }

  // set current puzzle meta (for stat recording)
  currentPuzzleMeta = { imageId: imgId, imageURL: imgSrc, cols: cols, rows: rows };

  shuffle();
  shuffleBtn.disabled = false;
  resetTimer();
  previewContainer.style.display = 'none';
  previewPuzzle.innerHTML = '';
  messageEl.textContent = '–ü–∞–∑–ª —Å–æ–∑–¥–∞–Ω. –ù–∞—á–Ω–∏—Ç–µ —Å–æ–±–∏—Ä–∞—Ç—å!';
}

/* shuffle */
shuffleBtn.addEventListener('click', ()=>{ shuffle(); solvedAlready=false; hideComplete(); resetTimer(); messageEl.textContent='–ü–∞–∑–ª –ø–µ—Ä–µ–º–µ—à–∞–Ω'; });
function shuffle(){
  if(!cells.length) return;
  const pieces = cells.map(c=>c.firstChild);
  for(let i=pieces.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [pieces[i],pieces[j]]=[pieces[j],pieces[i]]; }
  cells.forEach((cell,i)=>cell.appendChild(pieces[i]));
  document.querySelectorAll('.piece').forEach(p=>p.style.border='2px solid transparent');
}

/* drop handler */
function onDropOnCell(e){
  e.preventDefault();
  this.classList.remove('drop-target');
  const id = e.dataTransfer.getData('text/plain'); const dragged = document.getElementById(id);
  if(!dragged) return;
  const targetPiece = this.firstChild; const sourceCell = dragged.parentElement;
  if(sourceCell === this) return;
  sourceCell.appendChild(targetPiece);
  this.appendChild(dragged);
  dragged.classList.remove('selected','dragging');
  if(enableCheckEl.checked) checkPositions(); else if(isSolved()) finishPuzzle();
}

/* select & exchange via click */
function toggleSelect(piece){
  if(selectedPiece) selectedPiece.classList.remove('selected');
  if(selectedPiece===piece){ selectedPiece=null; } else { selectedPiece = piece; piece.classList.add('selected'); }
  if(!started && selectedPiece) startTimer();
}
puzzleEl.addEventListener('click', e=>{
  const cell = e.target.closest('.cell'); if(!cell || !selectedPiece) return;
  const targetPiece = cell.firstChild; const sourceCell = selectedPiece.parentElement;
  if(targetPiece === selectedPiece) return;
  sourceCell.appendChild(targetPiece); cell.appendChild(selectedPiece);
  selectedPiece.classList.remove('selected'); selectedPiece = null;
  if(enableCheckEl.checked) checkPositions(); else if(isSolved()) finishPuzzle();
});

/* check positions */
function checkPositions(){
  if(!cells.length) return;
  let solved = true;
  cells.forEach((cell,i)=>{
    const piece = cell.firstChild;
    if(+piece.dataset.correct === i) piece.style.border = '2px solid green';
    else { piece.style.border = '2px solid red'; solved = false; }
  });
  if(solved) finishPuzzle();
}
function isSolved(){ return cells.length && cells.every((cell,i)=> +cell.firstChild.dataset.correct === i); }

/* finish */
function finishPuzzle(){
  if(solvedAlready) return;
  solvedAlready = true;
  stopTimer();
  messageEl.textContent = '–ü–∞–∑–ª —Å–æ–±—Ä–∞–Ω! üéâ';
  const elapsedMs = (startTime ? Math.round(performance.now() - startTime) : 0);
  completeTime.textContent = '–í—Ä–µ–º—è: ' + formatTime(elapsedMs);
  showComplete();
  // save to user profile if logged in
  const user = getCurrentUser();
  if(user){
    saveResultForUser(user.email, {
      imageId: currentPuzzleMeta.imageId,
      imageURL: currentPuzzleMeta.imageURL,
      cols: currentPuzzleMeta.cols,
      rows: currentPuzzleMeta.rows,
      timeMs: elapsedMs,
      date: new Date().toISOString()
    });
  }
}
function showComplete(){ completeOverlay.style.display='flex'; completeOverlay.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
function hideComplete(){ completeOverlay.style.display='none'; completeOverlay.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }
completeShuffle.addEventListener('click', ()=>{ hideComplete(); shuffle(); resetTimer(); solvedAlready=false; messageEl.textContent='–ü–∞–∑–ª –ø–µ—Ä–µ–º–µ—à–∞–Ω'; });
completeNew.addEventListener('click', ()=>{ hideComplete(); openMenu(); });
completeClose.addEventListener('click', ()=>{ hideComplete(); });

/* timer */
function startTimer(){ if(started) return; started=true; startTime = performance.now(); timer = setInterval(()=>{ const t = performance.now()-startTime; timerDisplay.textContent = '–í—Ä–µ–º—è: ' + formatTime(Math.round(t)); }, 50); }
function stopTimer(){ clearInterval(timer); }
function resetTimer(){ clearInterval(timer); started=false; startTime=null; timerDisplay.textContent = '–í—Ä–µ–º—è: 0:00:000'; }

/* preview assembled */
previewBtn.addEventListener('click', ()=>{
  if(!currentPuzzleMeta && !imageURL) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ –º–µ–Ω—é.');
  if(previewContainer.style.display === 'block'){ previewContainer.style.display='none'; previewContainer.setAttribute('aria-hidden','true'); previewBtn.textContent='–ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É'; return; }
  const img = (currentPuzzleMeta && currentPuzzleMeta.imageURL) || imageURL;
  const useCols = (currentPuzzleMeta && currentPuzzleMeta.cols) || cols;
  const useRows = (currentPuzzleMeta && currentPuzzleMeta.rows) || rows;
  const canvasSize = 500; const pW = Math.floor(canvasSize / useCols); const pH = Math.floor(canvasSize / useRows);
  previewPuzzle.innerHTML = ''; previewPuzzle.style.gridTemplateColumns = `repeat(${useCols}, ${pW}px)`; previewPuzzle.style.gridTemplateRows = `repeat(${useRows}, ${pH}px)`;
  for(let i=0;i<useCols*useRows;i++){ const r=Math.floor(i/useCols), c=i%useCols; const pp=document.createElement('div'); pp.className='previewPiece'; pp.style.width=pW+'px'; pp.style.height=pH+'px'; pp.style.backgroundImage = `url(${img})`; pp.style.backgroundSize = `${useCols*pW}px ${useRows*pH}px`; pp.style.backgroundPosition = `-${c*pW}px -${r*pH}px`; previewPuzzle.appendChild(pp); }
  previewContainer.style.display='block'; previewContainer.setAttribute('aria-hidden','false'); previewBtn.textContent='–°–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É';
});

/* touch support */
let touchDrag = { piece:null, srcCell:null, currentTargetCell:null };
function onTouchStart(e){ e.preventDefault(); const piece = e.currentTarget; touchDrag.piece=piece; touchDrag.srcCell=piece.parentElement; piece.classList.add('dragging'); if(!started) startTimer(); }
function onTouchMove(e){ if(!touchDrag.piece) return; e.preventDefault(); const t = e.changedTouches[0]; const el = document.elementFromPoint(t.clientX, t.clientY); const cell = el ? el.closest('.cell') : null; if(cell !== touchDrag.currentTargetCell){ if(touchDrag.currentTargetCell) touchDrag.currentTargetCell.classList.remove('drop-target'); touchDrag.currentTargetCell = cell; if(cell) cell.classList.add('drop-target'); } }
function onTouchEnd(e){ if(!touchDrag.piece) return; const piece = touchDrag.piece; const targetCell = touchDrag.currentTargetCell; piece.classList.remove('dragging'); if(targetCell && targetCell !== touchDrag.srcCell){ const targetPiece = targetCell.firstChild; const srcCell = touchDrag.srcCell; srcCell.appendChild(targetPiece); targetCell.appendChild(piece); if(enableCheckEl.checked) checkPositions(); else if(isSolved()) finishPuzzle(); } document.querySelectorAll('.cell.drop-target').forEach(el=>el.classList.remove('drop-target')); touchDrag.piece=null; touchDrag.srcCell=null; touchDrag.currentTargetCell=null; }

/* ========== Accounts: registration, confirmation, login, stats ========== */

/*
 Storage schema (localStorage):
  - puzzle_users_v1 : {
      "<email>": {
         email,
         nick,
         age,
         pwHash,
         confirmed: boolean,
         confirmationCode: "123456",
         stats: [ {imageId,imageURL,cols,rows,timeMs,date}, ... ]
      }, ...
    }
  - puzzle_current_user : "<email>"
*/

// helper to generate 6-digit code
function genCode(){ return Math.floor(100000 + Math.random()*900000).toString(); }

async function registerUser(email, nick, age, password){
  const users = loadUsers();
  if(users[email]) return { ok:false, msg:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —ç—Ç–æ–π –ø–æ—á—Ç–æ–π —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.' };
  const pwHash = await sha256Hex(password);
  const code = genCode();
  users[email] = { email, nick, age: +age, pwHash, confirmed:false, confirmationCode:code, stats:[] };
  saveUsers(users);
  // "send" confirmation (demo) ‚Äî show code in UI (in production send real email)
  return { ok:true, code };
}

function confirmUser(email, code){
  const users = loadUsers();
  const u = users[email];
  if(!u) return { ok:false, msg:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.' };
  if(u.confirmed) return { ok:false, msg:'–£–∂–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω.' };
  if(u.confirmationCode === code){ u.confirmed = true; delete u.confirmationCode; saveUsers(users); return { ok:true }; }
  return { ok:false, msg:'–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥.' };
}

async function loginUser(email, password){
  const users = loadUsers(); const u = users[email];
  if(!u) return { ok:false, msg:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.' };
  const hash = await sha256Hex(password);
  if(hash !== u.pwHash) return { ok:false, msg:'–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å.' };
  if(!u.confirmed) return { ok:false, msg:'–ü–æ—á—Ç–∞ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞. –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–¥ —Å–Ω–æ–≤–∞.' };
  setCurrentUser(email);
  return { ok:true, user:u };
}

function logoutUser(){ setCurrentUser(null); }

// resend confirmation (demo)
function resendConfirmation(email){
  const users = loadUsers(); const u = users[email];
  if(!u) return { ok:false, msg:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.' };
  if(u.confirmed) return { ok:false, msg:'–£–∂–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω.' };
  const code = genCode(); u.confirmationCode = code; saveUsers(users); return { ok:true, code };
}

/* save a puzzle result to user */
function saveResultForUser(email, result){
  const users = loadUsers(); const u = users[email];
  if(!u) return false;
  u.stats = u.stats || [];
  u.stats.push(result);
  saveUsers(users);
  return true;
}

/* get stats for current user */
function loadStatsForCurrentUser(){
  const user = getCurrentUser(); if(!user) return null;
  return user.stats || [];
}

/* ========== Account UI logic ========== */

// tab switching
function showTab(tab){
  [tabLogin, tabRegister, tabProfile, tabStats].forEach(t=>t.classList.remove('active'));
  [paneLogin, paneRegister, paneProfile, paneStats].forEach(p=>p.style.display='none');
  if(tab==='login'){ tabLogin.classList.add('active'); paneLogin.style.display='block'; }
  if(tab==='register'){ tabRegister.classList.add('active'); paneRegister.style.display='block'; }
  if(tab==='profile'){ tabProfile.classList.add('active'); paneProfile.style.display='block'; updateProfilePane(); }
  if(tab==='stats'){ tabStats.classList.add('active'); paneStats.style.display='block'; updateStatsPane(); }
}

tabLogin.addEventListener('click', ()=>showTab('login'));
tabRegister.addEventListener('click', ()=>showTab('register'));
tabProfile.addEventListener('click', ()=>showTab('profile'));
tabStats.addEventListener('click', ()=>showTab('stats'));

// open account overlay
function openAccount(){ accountOverlay.style.display='flex'; accountOverlay.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; showTab(getCurrentUser() ? 'profile' : 'login'); updateLoginStateUI(); }
function closeAccount(){ accountOverlay.style.display='none'; accountOverlay.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }
accountBtn.addEventListener('click', ()=>{ if(accountOverlay.style.display==='flex') closeAccount(); else openAccount(); });
accountClose.addEventListener('click', closeAccount);
accountOverlay.addEventListener('click', e=>{ if(e.target===accountOverlay) closeAccount(); });

// go to register from login
$('goToRegister').addEventListener('click', ()=> showTab('register'));

/* Registration flow */
regBtn.addEventListener('click', async ()=>{
  const email = regEmail.value.trim().toLowerCase();
  const nick = regNick.value.trim();
  const age = regAge.value;
  const pw = regPassword.value;
  const pw2 = regPassword2.value;
  regMsg.style.color = 'var(--muted)';
  if(!email || !nick || !age || !pw || !pw2){ regMsg.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è.'; return; }
  if(pw !== pw2){ regMsg.textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç.'; return; }
  if(pw.length < 6){ regMsg.textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤.'; return; }
  const res = await registerUser(email, nick, age, pw);
  if(!res.ok){ regMsg.style.color = 'var(--danger)'; regMsg.textContent = res.msg; return; }
  regMsg.style.color = '#228822';
  regMsg.textContent = `–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ. –ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–¥–µ–º–æ): ${res.code}. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∫–ª–∞–¥–∫—É "–ü—Ä–æ—Ñ–∏–ª—å" –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–æ—á—Ç—É (–≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥).`;
  // clear form except email maybe
  // pre-fill login fields
  loginEmail.value = email;
});

/* Login flow */
loginBtn.addEventListener('click', async ()=>{
  const email = loginEmail.value.trim().toLowerCase();
  const pw = loginPassword.value || '';
  loginMsg.style.color = 'var(--muted)';
  if(!email || !pw){ loginMsg.textContent = '–í–≤–µ–¥–∏—Ç–µ –ø–æ—á—Ç—É –∏ –ø–∞—Ä–æ–ª—å.'; return; }
  const res = await loginUser(email, pw);
  if(!res.ok){ loginMsg.style.color = 'var(--danger)'; loginMsg.textContent = res.msg; return; }
  loginMsg.style.color = '#228822'; loginMsg.textContent = '–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω.';
  // update UI
  updateLoginStateUI();
  showTab('profile');
});

/* profile pane */
function updateLoginStateUI(){
  const user = getCurrentUser();
  if(user){
    $('accountBtn').textContent = user.nick || '–ê–∫–∫–∞—É–Ω—Ç';
  } else {
    $('accountBtn').textContent = '–ê–∫–∫–∞—É–Ω—Ç';
  }
}

function updateProfilePane(){
  const user = getCurrentUser();
  if(!user){
    profileInfo.innerHTML = '<em>–í—ã –Ω–µ –≤–æ—à–ª–∏. –í–æ–π–¥–∏—Ç–µ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å.</em>';
    profileMsg.textContent = '';
    return;
  }
  profileInfo.innerHTML = `<strong>${user.nick}</strong><br>–ü–æ—á—Ç–∞: ${user.email}<br>–í–æ–∑—Ä–∞—Å—Ç: ${user.age}<br>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞: ${user.confirmed ? '–¥–∞' : '–Ω–µ—Ç'}`;
  profileMsg.textContent = '';
}

/* logout */
logoutBtn.addEventListener('click', ()=>{
  logoutUser();
  updateLoginStateUI();
  showTab('login');
  profileMsg.textContent = '–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞.';
});

/* resend confirmation */
resendConfirmBtn.addEventListener('click', ()=>{
  const user = getCurrentUser();
  if(!user){ profileMsg.textContent = '–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.'; return; }
  if(user.confirmed){ profileMsg.textContent = '–ü–æ—á—Ç–∞ —É–∂–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞.'; return; }
  const res = resendConfirmation(user.email);
  if(res.ok){ profileMsg.style.color = '#228822'; profileMsg.textContent = `–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω (–¥–µ–º–æ): ${res.code}`; }
  else { profileMsg.style.color = 'var(--danger)'; profileMsg.textContent = res.msg; }
});

/* In profile pane allow entering confirmation code */
function addConfirmFormToProfile(){
  const container = document.createElement('div'); container.style.marginTop = '8px';
  container.innerHTML = `<div style="display:flex;gap:8px;align-items:center;">
    <input id="confirmCodeInput" class="input" placeholder="–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è">
    <button id="confirmCodeBtn" class="btn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
  </div><div id="confirmCodeMsg" style="margin-top:6px;color:var(--muted)"></div>`;
  paneProfile.appendChild(container);
  $('confirmCodeBtn').addEventListener('click', ()=>{
    const code = $('confirmCodeInput').value.trim();
    const user = getCurrentUser(); if(!user){ $('confirmCodeMsg').textContent='–í–æ–π–¥–∏—Ç–µ.'; return; }
    const res = confirmUser(user.email, code);
    if(res.ok){ $('confirmCodeMsg').style.color='#228822'; $('confirmCodeMsg').textContent='–ü–æ—á—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞.'; updateProfilePane(); updateLoginStateUI(); }
    else { $('confirmCodeMsg').style.color='var(--danger)'; $('confirmCodeMsg').textContent = res.msg; }
  });
}
addConfirmFormToProfile();

/* ========== Stats UI ========== */
function updateStatsPane(){
  const user = getCurrentUser();
  if(!user){ statsSummary.textContent = '–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.'; statsTableBody.innerHTML = ''; return; }
  const stats = user.stats || [];
  statsSummary.textContent = `–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: ${stats.length}`;
  // show latest first
  const rowsHtml = stats.slice().reverse().map(s=>{
    const imgLabel = s.imageId && s.imageId.startsWith('uploaded:') ? '–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ' : (presets.find(p=>p.id===s.imageId)?.title || s.imageId || '–ö–∞—Ä—Ç–∏–Ω–∫–∞');
    return `<tr>
      <td>${imgLabel}</td>
      <td>${s.cols}√ó${s.rows}</td>
      <td>${formatTime(s.timeMs)}</td>
      <td>${new Date(s.date).toLocaleString()}</td>
    </tr>`;
  }).join('');
  statsTableBody.innerHTML = rowsHtml;
}

/* ========== Confirmation helpers ========= */
/* For demo, allow user to confirm registration by email entry even if not logged in:
   - When user registers, we show the code in regMsg. They can log in only after confirming.
   - We also allow "resend" and "confirm" in profile when logged in.
*/

/* ========== Initialization: account UI wiring & state ========== */
accountOverlay.style.display = 'none';
menuOverlay.style.display = 'none';
completeOverlay.style.display = 'none';
buildPresetThumbnails();
updateLoginStateUI();

/* handle overlay close with ESC */
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ if(menuOverlay.style.display==='flex') closeMenu(); if(accountOverlay.style.display==='flex') closeAccount(); if(completeOverlay.style.display==='flex') hideComplete(); } });

/* show account overlay controls */
accountBtn.addEventListener('click', ()=>{ if(accountOverlay.style.display==='flex') closeAccount(); else openAccount(); });

/* ensure pane refs exist (they were defined in HTML) */
if(!paneLogin || !paneRegister || !paneProfile || !paneStats){
  console.warn('–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø–∞–Ω–µ–ª–∏ –∞–∫–∫–∞—É–Ω—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã (–≤–µ—Ä—Å—Ç–∫–∞).');
}

/* If user is logged in, pre-select profile tab when opening */
function saveUsersBackToUI(){ /* placeholder if needed later */ }

/* When page unload, revoke uploaded object URLs? We keep them local for the session. */

/* ========== End of script ========== */
</script>

</body>
</html>
