<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–∞–∑–ª</title>
<style>
body {
  font-family: Arial, sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  background: #f0f0f0;
  padding: 20px;
}
#controls {
  margin-bottom: 20px;
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
}
#puzzle {
  display: grid;
  gap: 2px;
  background: #ccc;
  padding: 5px;
  border: 2px solid #000;
  min-width: 200px;
  min-height: 200px;
}
.piece {
  background-size: cover;
  cursor: grab;
  width: 100px;
  height: 100px;
  user-select: none;
}
#message { margin-top: 12px; font-weight: bold; }
</style>
</head>
<body>
<h1>–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–∞–∑–ª</h1>
<div id="controls">
  <input type="file" id="imageUpload" accept="image/*" />
  <label>–®–∏—Ä–∏–Ω–∞:</label>
  <input type="number" id="cols" min="2" max="15" value="5" style="width:60px" />
  <label>–í—ã—Å–æ—Ç–∞:</label>
  <input type="number" id="rows" min="2" max="15" value="6" style="width:60px" />
  <button id="generate">–°–æ–∑–¥–∞—Ç—å –ø–∞–∑–ª</button>
</div>
<div id="puzzle"></div>
<div id="message"></div>
<script>
const imgInput = document.getElementById('imageUpload');
const generateBtn = document.getElementById('generate');
const puzzle = document.getElementById('puzzle');
const message = document.getElementById('message');

let imageURL = '';

imgInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (file) imageURL = URL.createObjectURL(file);
});

generateBtn.addEventListener('click', () => {
  if (!imageURL) return alert('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ!');

  const cols = parseInt(document.getElementById('cols').value);
  const rows = parseInt(document.getElementById('rows').value);

  puzzle.innerHTML = '';
  puzzle.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
  puzzle.style.gridTemplateRows = `repeat(${rows}, 1fr)`;

  const total = rows * cols;
  const pieces = [];

  for (let i = 0; i < total; i++) {
    const piece = document.createElement('div');
    piece.className = 'piece';

    const row = Math.floor(i / cols);
    const col = i % cols;

    piece.style.backgroundImage = `url(${imageURL})`;
    piece.style.backgroundSize = `${cols * 100}% ${rows * 100}%`;
    piece.style.backgroundPosition = `${(col/(cols-1))*100}% ${(row/(rows-1))*100}%`;

    piece.dataset.correct = i;

    makeDraggable(piece);
    pieces.push(piece);
  }

  pieces.sort(() => Math.random() - 0.5);
  pieces.forEach(p => puzzle.appendChild(p));
});

function makeDraggable(piece) {
  piece.draggable = true;
  piece.addEventListener('dragstart', e => e.dataTransfer.setData('index', [...puzzle.children].indexOf(piece)));
  piece.addEventListener('dragover', e => e.preventDefault());
  piece.addEventListener('drop', e => {
    e.preventDefault();
    const from = e.dataTransfer.getData('index');
    const to = [...puzzle.children].indexOf(e.target);
    swapPieces(from, to);
    checkSolved();
  });
}

function swapPieces(i, j) {
  const pieces = [...puzzle.children];
  if(i === j) return;
  puzzle.insertBefore(pieces[i], pieces[j]);
  puzzle.insertBefore(pieces[j], pieces[i+1] || null);
}

function checkSolved() {
  const items = [...puzzle.children];
  let solved = true;
  items.forEach((p, i) => { if (p.dataset.correct != i) solved = false; });
  message.textContent = solved ? '–ü–∞–∑–ª —Å–æ–±—Ä–∞–Ω! üéâ' : '';
}
</script>
</body>
</html>
