<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–∞–∑–ª</title>
<style>
  body {
    font-family: Arial, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 18px;
    margin: 0;
    min-height: 100vh;
    background: #f5f5f5;
  }

  #topRow {
    width: 100%;
    max-width: 1100px;
    display: flex;
    gap: 12px;
    align-items: flex-start;
  }

  #menu {
    width: 220px;
    background: #fff;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    box-sizing: border-box;
  }

  #menu h3 { margin: 6px 0 8px; font-size: 14px; }
  .presetList { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .presetItem {
    border: 2px solid transparent;
    border-radius: 6px;
    overflow: hidden;
    cursor: pointer;
    background: #f6f6f6;
  }
  .presetItem.selected { border-color: #2196f3; box-shadow: 0 4px 12px rgba(33,150,243,0.12); }
  .presetItem img { display:block; width:100%; height:64px; object-fit:cover; }

  .menu-controls { margin-top:10px; display:flex; flex-direction:column; gap:8px; }
  .presetSizes { display:flex; gap:6px; flex-wrap:wrap; }
  .presetSizes button { padding:6px 8px; border-radius:6px; border:1px solid #ddd; background:#fff; cursor:pointer; }
  .presetSizes button.active { background:#2196f3; color:#fff; border-color: #1976d2; }

  #controls {
    flex: 1;
    background: #fff;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    display:flex;
    gap:8px;
    align-items: center;
    flex-wrap:wrap;
  }

  #puzzleArea {
    margin-top: 14px;
    width: 100%;
    max-width: 1100px;
    display: flex;
    gap: 14px;
    align-items: flex-start;
  }

  #puzzle {
    display: grid;
    gap: 2px;
    border: 2px solid #000;
    padding: 5px;
    touch-action: none;
    background: #fafafa;
    z-index: 1;
  }

  .cell {
    position: relative;
    overflow: hidden;
    background: #eee;
  }

  .piece {
    width: 100%;
    height: 100%;
    background-size: cover;
    cursor: grab;
    user-select: none;
    transition: transform 150ms ease, border-color 120ms;
    box-sizing: border-box;
    border: 2px solid transparent;
  }

  .piece.dragging {
    opacity: 0.6;
    cursor: grabbing;
    transform: scale(1.02);
    z-index: 10;
  }

  .piece.selected {
    outline: 3px dashed #666;
  }

  #message {
    margin-top: 12px;
    font-weight: bold;
  }

  #previewContainer {
    margin-top: 15px;
    display: none;
    text-align: center;
    z-index: 1;
  }

  #previewPuzzle {
    display: grid;
    gap: 2px;
    border: 2px solid #444;
    padding: 5px;
    background: #fff;
  }

  .previewPiece {
    width: 100%;
    height: 100%;
    background-size: cover;
    box-sizing: border-box;
    border: 2px solid #44444a;
  }

  .cell.drop-target {
    box-shadow: inset 0 0 0 3px rgba(0, 120, 215, 0.25);
  }

  /* Overlay modal for congratulations */
  #overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.55);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    padding: 20px;
  }

  #overlay .modal {
    background: #fff;
    padding: 22px;
    border-radius: 8px;
    max-width: 95%;
    width: 460px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  }

  #overlay .modal h2 {
    margin: 6px 0 12px;
    font-size: 1.25rem;
  }

  #overlay .modal p {
    margin: 8px 0 16px;
  }

  #overlay .modal .actions {
    display:flex;
    gap: 10px;
    justify-content: center;
    flex-wrap:wrap;
  }

  .btn {
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid #ddd;
    background: #fff;
    cursor: pointer;
  }
  .btn.primary { background:#2196f3; color:#fff; border-color:#1976d2; }
  .btn.warn { background:#ff7043; color:#fff; border-color:#e64a19; }

  @media (max-width: 980px) {
    #topRow { flex-direction: column; align-items: stretch; }
    #menu { width: 100%; order: 2; }
  }
</style>
</head>

<body>

<h1>–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–∞–∑–ª</h1>

<div id="topRow">
  <div id="menu" aria-label="–ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ —Ä–∞–∑–º–µ—Ä–æ–≤">
    <h3>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É</h3>
    <div class="presetList" id="presetList">
      <!-- items injected by JS -->
    </div>

    <div class="menu-controls">
      <h3>–†–∞–∑–º–µ—Ä (–ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–∫–∏)</h3>
      <div class="presetSizes" id="presetSizes">
        <button data-cols="3" data-rows="3">3 √ó 3</button>
        <button data-cols="5" data-rows="6" class="active">5 √ó 6</button>
        <button data-cols="8" data-rows="6">8 √ó 6</button>
        <button data-cols="10" data-rows="8">10 √ó 8</button>
      </div>

      <div style="display:flex; gap:8px; align-items:center;">
        <label>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π:
          <input type="number" id="cols" min="1" max="30" value="5" style="width:60px; margin-left:6px">
          √ó
          <input type="number" id="rows" min="1" max="30" value="6" style="width:60px; margin-left:6px">
        </label>
      </div>

      <div style="display:flex; gap:6px;">
        <button id="generate" class="btn primary">–°–æ–∑–¥–∞—Ç—å –ø–∞–∑–ª</button>
        <button id="useUploaded" class="btn">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ</button>
      </div>
    </div>
  </div>

  <div id="controls">
    <input type="file" id="imageUpload" accept="image/*" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ—é –∫–∞—Ä—Ç–∏–Ω–∫—É">
    <label style="display:flex;align-items:center;gap:6px;">
      <input type="checkbox" id="enableCheck" checked>
      –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–∑–∏—Ü–∏–∏ –¥–µ—Ç–∞–ª–µ–π
    </label>
    <button id="shuffleBtn" class="btn" disabled>–ü–µ—Ä–µ–º–µ—à–∞—Ç—å</button>
    <button id="previewBtn" class="btn">–ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É</button>
    <div style="margin-left:auto; font-size:13px; color:#444">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –ø–ª–∏—Ç–∫–∏ –∏–ª–∏ –∫–ª–∏–∫–∞–π—Ç–µ —á—Ç–æ–±—ã –æ–±–º–µ–Ω—è—Ç—å</div>
  </div>
</div>

<div id="puzzleArea">
  <div id="previewContainer" style="display:none;">
    <h3>–ö–∞–∫ –¥–æ–ª–∂–Ω–æ –≤—ã–≥–ª—è–¥–µ—Ç—å:</h3>
    <div id="previewPuzzle"></div>
  </div>

  <div id="puzzle" aria-label="–ü–æ–ª–µ –ø–∞–∑–ª–∞"></div>
</div>

<div id="message" aria-live="polite"></div>
<h3 id="timer">–í—Ä–µ–º—è: 0:00:000 </h3>

<!-- Overlay modal -->
<div id="overlay" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal" role="document">
    <h2 id="overlayTitle">–£—Ä–∞! –ü–∞–∑–ª —Å–æ–±—Ä–∞–Ω üéâ</h2>
    <p id="overlayTime">–í—Ä–µ–º—è: 0:00:000</p>
    <div class="actions">
      <button id="overlayShuffle" class="btn">–ü–µ—Ä–µ–º–µ—à–∞—Ç—å</button>
      <button id="overlayNew" class="btn primary">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–∞–∑–ª</button>
      <button id="overlayClose" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<script>
/* ========== –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø—Ä–µ—Å–µ—Ç–æ–≤ ========== */
const presetImages = [
  { id: 'preset1', title: '–ì–æ—Ä—ã', url: 'https://images.unsplash.com/photo-1501785888041-af3ef285b470?q=80&w=800&auto=format&fit=crop&ixlib=rb-4.0.3&s=4f6b44d0b4f3c5a5f8a800736bb0c5fb' },
  { id: 'preset2', title: '–ì–æ—Ä–æ–¥', url: 'https://images.unsplash.com/photo-1491553895911-0055eca6402d?q=80&w=800&auto=format&fit=crop&ixlib=rb-4.0.3&s=96c5dd2a3e5c8b3a5a1a0621d5cf72ea' },
  { id: 'preset3', title: '–ü—Ç–∏—Ü–∞', url: 'https://images.unsplash.com/photo-1507149833265-60c372daea22?q=80&w=800&auto=format&fit=crop&ixlib=rb-4.0.3&s=2b9e7cfb9d4b3d28a9b8b8f6a6e8a3cc' },
  { id: 'preset4', title: '–ê–±—Å—Ç—Ä–∞–∫—Ç', url: 'https://images.unsplash.com/photo-1504198453319-5ce911bafcde?q=80&w=800&auto=format&fit=crop&ixlib=rb-4.0.3&s=0a9d7d4b4b5e8d3b4f7e4a6b9c6d5f2f' }
];

const presetList = document.getElementById('presetList');
const presetSizes = document.getElementById('presetSizes');

let selectedPreset = null;
let uploadedImageURL = '';
let imageURL = ''; // current image to use
let cols = 5, rows = 6;
let pieceWidth = 100, pieceHeight = 100;
let cells = [];
let started = false;
let startTime = null;
let timer = null;
let pieceIdCounter = 0;
let solvedAlready = false;

/* Inject preset thumbnails */
presetImages.forEach(p => {
  const el = document.createElement('div');
  el.className = 'presetItem';
  el.dataset.id = p.id;
  el.title = p.title;
  el.innerHTML = `<img src="${p.url}" alt="${p.title}"><div style="padding:6px;font-size:12px;text-align:center;">${p.title}</div>`;
  el.addEventListener('click', () => {
    document.querySelectorAll('.presetItem').forEach(i => i.classList.remove('selected'));
    el.classList.add('selected');
    selectedPreset = p;
    imageURL = p.url;
  });
  presetList.appendChild(el);
});

/* Select first preset by default */
if (presetList.firstChild) {
  presetList.firstChild.click();
}

/* Preset size buttons */
presetSizes.querySelectorAll('button').forEach(btn => {
  btn.addEventListener('click', () => {
    presetSizes.querySelectorAll('button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const c = +btn.dataset.cols;
    const r = +btn.dataset.rows;
    document.getElementById('cols').value = c;
    document.getElementById('rows').value = r;
  });
});

/* ===== –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏ ===== */
const imgInput = document.getElementById('imageUpload');
const generateBtn = document.getElementById('generate');
const useUploaded = document.getElementById('useUploaded');
const shuffleBtn = document.getElementById('shuffleBtn');
const previewBtn = document.getElementById('previewBtn');
const enableCheck = document.getElementById('enableCheck');
const puzzle = document.getElementById('puzzle');
const previewContainer = document.getElementById('previewContainer');
const previewPuzzle = document.getElementById('previewPuzzle');
const message = document.getElementById('message');
const timerDisplay = document.getElementById('timer');

const overlay = document.getElementById('overlay');
const overlayTime = document.getElementById('overlayTime');
const overlayShuffle = document.getElementById('overlayShuffle');
const overlayNew = document.getElementById('overlayNew');
const overlayClose = document.getElementById('overlayClose');

imgInput.addEventListener('change', e => {
  if (e.target.files && e.target.files[0]) {
    // revoke previous if exists
    if (uploadedImageURL) URL.revokeObjectURL(uploadedImageURL);
    uploadedImageURL = URL.createObjectURL(e.target.files[0]);
    imageURL = uploadedImageURL;
    // mark none selected in presets
    document.querySelectorAll('.presetItem').forEach(i => i.classList.remove('selected'));
    selectedPreset = null;
    message.textContent = '–ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ù–∞–∂–º–∏—Ç–µ "–°–æ–∑–¥–∞—Ç—å –ø–∞–∑–ª".';
  }
});

/* Use uploaded button (quick apply) */
useUploaded.addEventListener('click', () => {
  if (!uploadedImageURL) return alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ—é –∫–∞—Ä—Ç–∏–Ω–∫—É".');
  imageURL = uploadedImageURL;
  document.querySelectorAll('.presetItem').forEach(i => i.classList.remove('selected'));
  selectedPreset = null;
  message.textContent = '–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞. –ù–∞–∂–º–∏—Ç–µ "–°–æ–∑–¥–∞—Ç—å –ø–∞–∑–ª".';
});

/* ===== –°–û–ó–î–ê–ù–ò–ï –ü–ê–ó–õ–ê ===== */
generateBtn.addEventListener('click', () => {
  if (!imageURL) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –º–µ–Ω—é —Å–ª–µ–≤–∞.');
  cols = Math.max(1, Math.min(30, +document.getElementById('cols').value || 1));
  rows = Math.max(1, Math.min(30, +document.getElementById('rows').value || 1));

  createPuzzle(imageURL, cols, rows);
});

/* createPuzzle - –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä */
function createPuzzle(imgSrc, c, r) {
  cols = c; rows = r;
  // fixed canvas used to compute background sizes
  const canvasSize = 500;
  pieceWidth = Math.floor(canvasSize / cols);
  pieceHeight = Math.floor(canvasSize / rows);

  puzzle.innerHTML = '';
  cells = [];
  pieceIdCounter = 0;
  solvedAlready = false;

  puzzle.style.gridTemplateColumns = `repeat(${cols}, ${pieceWidth}px)`;
  puzzle.style.gridTemplateRows = `repeat(${rows}, ${pieceHeight}px)`;

  for (let i = 0; i < cols * rows; i++) {
    const cell = document.createElement('div');
    cell.className = 'cell';
    cell.style.width = pieceWidth + 'px';
    cell.style.height = pieceHeight + 'px';
    cell.dataset.index = i;

    cell.addEventListener('dragover', e => {
      e.preventDefault();
      cell.classList.add('drop-target');
    });
    cell.addEventListener('dragleave', () => cell.classList.remove('drop-target'));
    cell.addEventListener('drop', onDropOnCell);

    const piece = document.createElement('div');
    piece.className = 'piece';
    piece.draggable = true;
    piece.id = 'piece-' + (pieceIdCounter++);

    const rr = Math.floor(i / cols);
    const cc = i % cols;

    piece.style.backgroundImage = `url(${imgSrc})`;
    piece.style.backgroundSize = `${cols * pieceWidth}px ${rows * pieceHeight}px`;
    piece.style.backgroundPosition = `-${cc * pieceWidth}px -${rr * pieceHeight}px`;
    piece.dataset.correct = i;

    piece.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text/plain', piece.id);
      piece.classList.add('dragging');
      if (!started) startTimer();
    });
    piece.addEventListener('dragend', () => {
      piece.classList.remove('dragging');
      document.querySelectorAll('.cell.drop-target').forEach(el => el.classList.remove('drop-target'));
    });

    piece.addEventListener('click', e => {
      e.stopPropagation();
      toggleSelect(piece);
    });

    piece.addEventListener('touchstart', onTouchStart, {passive:false});
    piece.addEventListener('touchmove', onTouchMove, {passive:false});
    piece.addEventListener('touchend', onTouchEnd);

    cell.appendChild(piece);
    cells.push(cell);
    puzzle.appendChild(cell);
  }

  shuffle();
  shuffleBtn.disabled = false;
  resetTimer();
  message.textContent = '–ü–∞–∑–ª —Å–æ–∑–¥–∞–Ω. –ù–∞—á–Ω–∏—Ç–µ —Å–æ–±–∏—Ä–∞—Ç—å!';
  // hide preview so user focuses on puzzle
  previewContainer.style.display = 'none';
  previewBtn.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É';
}

/* ===== –ü–ï–†–ï–ú–ï–®–ò–í–ê–ù–ò–ï ===== */
shuffleBtn.addEventListener('click', () => {
  shuffle();
  solvedAlready = false;
  hideOverlay();
  resetTimer();
  message.textContent = '–ü–∞–∑–ª –ø–µ—Ä–µ–º–µ—à–∞–Ω';
});

function shuffle() {
  if (!cells.length) return;
  const pieces = cells.map(c => c.firstChild);
  for (let i = pieces.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [pieces[i], pieces[j]] = [pieces[j], pieces[i]];
  }
  cells.forEach((cell, i) => cell.appendChild(pieces[i]));
  document.querySelectorAll('.piece').forEach(p => p.style.border = '2px solid transparent');
}

/* ===== DROP –Ω–∞ —è—á–µ–π–∫—É ===== */
function onDropOnCell(e) {
  e.preventDefault();
  this.classList.remove('drop-target');
  const draggedId = e.dataTransfer.getData('text/plain');
  const dragged = document.getElementById(draggedId);
  if (!dragged) return;

  const targetPiece = this.firstChild;
  const sourceCell = dragged.parentElement;

  if (sourceCell === this) return;

  sourceCell.appendChild(targetPiece);
  this.appendChild(dragged);

  dragged.classList.remove('selected', 'dragging');

  if (enableCheck.checked) checkPositions();
  else if (isSolved()) finishPuzzle();
}

/* ===== –í–´–î–ï–õ–ï–ù–ò–ï –ö–õ–ò–ö–û–ú ===== */
let selectedPiece = null;
function toggleSelect(piece) {
  if (selectedPiece) selectedPiece.classList.remove('selected');
  if (selectedPiece === piece) {
    selectedPiece = null;
  } else {
    selectedPiece = piece;
    piece.classList.add('selected');
  }
  if (!started && selectedPiece) startTimer();
}

/* ===== –ö–õ–ò–ö –ü–û –Ø–ß–ï–ô–ö–ï (–æ–±–º–µ–Ω) ===== */
puzzle.addEventListener('click', e => {
  const cell = e.target.closest('.cell');
  if (!cell || !selectedPiece) return;

  const targetPiece = cell.firstChild;
  const sourceCell = selectedPiece.parentElement;

  if (targetPiece === selectedPiece) return;

  sourceCell.appendChild(targetPiece);
  cell.appendChild(selectedPiece);

  selectedPiece.classList.remove('selected');
  selectedPiece = null;

  if (enableCheck.checked) checkPositions();
  else if (isSolved()) finishPuzzle();
});

/* ===== –ü–†–û–í–ï–†–ö–ê ===== */
function checkPositions() {
  let solved = true;

  cells.forEach((cell, i) => {
    const piece = cell.firstChild;
    if (+piece.dataset.correct === i) {
      piece.style.border = '2px solid green';
    } else {
      piece.style.border = '2px solid red';
      solved = false;
    }
  });

  if (solved) finishPuzzle();
}

function isSolved() {
  return cells.length && cells.every((cell, i) =>
    +cell.firstChild.dataset.correct === i
  );
}

/* ===== –§–ò–ù–ò–® (–ø–æ–∫–∞–∑ overlay) ===== */
function finishPuzzle() {
  if (solvedAlready) return;
  solvedAlready = true;

  stopTimer();
  message.textContent = '–ü–∞–∑–ª —Å–æ–±—Ä–∞–Ω! üéâ';

  const formatted = formatElapsedTime();
  overlayTime.textContent = `–í—Ä–µ–º—è: ${formatted}`;
  showOverlay();
}

/* Overlay controls */
function showOverlay() {
  overlay.style.display = 'flex';
  overlay.setAttribute('aria-hidden', 'false');
  document.body.style.overflow = 'hidden';
}

function hideOverlay() {
  overlay.style.display = 'none';
  overlay.setAttribute('aria-hidden', 'true');
  document.body.style.overflow = '';
}

overlayShuffle.addEventListener('click', () => {
  hideOverlay();
  shuffle();
  resetTimer();
  solvedAlready = false;
  message.textContent = '–ü–∞–∑–ª –ø–µ—Ä–µ–º–µ—à–∞–Ω';
});

overlayClose.addEventListener('click', () => {
  hideOverlay();
});

/* –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–∞–∑–ª –∏–∑ overlay: –ø–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é (—Å–∫—Ä–æ–ª–ª –∫ –º–µ–Ω—é) */
overlayNew.addEventListener('click', () => {
  hideOverlay();
  // Scroll to top and focus menu
  window.scrollTo({ top: 0, behavior: 'smooth' });
  const firstPreset = document.querySelector('.presetItem');
  if (firstPreset) firstPreset.scrollIntoView({ block: 'center', behavior: 'smooth' });
});

/* ===== –¢–ê–ô–ú–ï–† ===== */
function startTimer() {
  if (started) return;
  started = true;
  startTime = performance.now();

  timer = setInterval(() => {
    const t = performance.now() - startTime;
    const ms = Math.floor(t % 1000).toString().padStart(3, '0');
    const sec = Math.floor(t / 1000) % 60;
    const min = Math.floor(t / 60000);

    timerDisplay.textContent =
      `–í—Ä–µ–º—è: ${min}:${sec.toString().padStart(2,'0')}:${ms}`;
  }, 50);
}

function stopTimer() {
  clearInterval(timer);
}

function resetTimer() {
  clearInterval(timer);
  started = false;
  startTime = null;
  timerDisplay.textContent = '–í—Ä–µ–º—è: 0:00:000';
}

function formatElapsedTime() {
  if (!startTime) return '0:00:000';
  const t = performance.now() - startTime;
  const ms = Math.floor(t % 1000).toString().padStart(3, '0');
  const sec = Math.floor(t / 1000) % 60;
  const min = Math.floor(t / 60000);
  return `${min}:${sec.toString().padStart(2,'0')}:${ms}`;
}

/* ===== –ü–†–ï–í–¨–Æ ‚Äî –¢–ê–ö –ñ–ï, –ö–ê–ö –ü–ê–ó–õ (–°–ë–û–†–ö–ê) ===== */
previewBtn.addEventListener('click', () => {
  if (!imageURL) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –º–µ–Ω—é —Å–ª–µ–≤–∞.');

  if (previewContainer.style.display === 'block') {
    previewContainer.style.display = 'none';
    previewBtn.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É';
    return;
  }

  const useCols = cols || Math.max(1, +document.getElementById('cols').value || 1);
  const useRows = rows || Math.max(1, +document.getElementById('rows').value || 1);
  const canvasSize = 500;
  const pW = Math.floor(canvasSize / useCols);
  const pH = Math.floor(canvasSize / useRows);

  previewPuzzle.innerHTML = '';
  previewPuzzle.style.gridTemplateColumns = `repeat(${useCols}, ${pW}px)`;
  previewPuzzle.style.gridTemplateRows = `repeat(${useRows}, ${pH}px)`;

  for (let i = 0; i < useCols * useRows; i++) {
    const r = Math.floor(i / useCols);
    const c = i % useCols;

    const pp = document.createElement('div');
    pp.className = 'previewPiece';
    pp.style.width = pW + 'px';
    pp.style.height = pH + 'px';
    pp.style.backgroundImage = `url(${imageURL})`;
    pp.style.backgroundSize = `${useCols * pW}px ${useRows * pH}px`;
    pp.style.backgroundPosition = `-${c * pW}px -${r * pH}px`;
    previewPuzzle.appendChild(pp);
  }

  previewContainer.style.display = 'block';
  previewBtn.textContent = '–°–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É';
});

/* ===== TOUCH-DRAG SUPPORT (–¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö) ===== */
let touchDrag = {
  piece: null,
  srcCell: null,
  currentTargetCell: null
};

function onTouchStart(e) {
  e.preventDefault();
  const piece = e.currentTarget;
  touchDrag.piece = piece;
  touchDrag.srcCell = piece.parentElement;
  piece.classList.add('dragging');
  if (!started) startTimer();
}

function onTouchMove(e) {
  if (!touchDrag.piece) return;
  e.preventDefault();
  const touch = e.changedTouches[0];
  const el = document.elementFromPoint(touch.clientX, touch.clientY);
  const cell = el ? el.closest('.cell') : null;
  if (cell !== touchDrag.currentTargetCell) {
    if (touchDrag.currentTargetCell) touchDrag.currentTargetCell.classList.remove('drop-target');
    touchDrag.currentTargetCell = cell;
    if (cell) cell.classList.add('drop-target');
  }
}

function onTouchEnd(e) {
  if (!touchDrag.piece) return;
  const piece = touchDrag.piece;
  const targetCell = touchDrag.currentTargetCell;
  piece.classList.remove('dragging');

  if (targetCell && targetCell !== touchDrag.srcCell) {
    const targetPiece = targetCell.firstChild;
    const srcCell = touchDrag.srcCell;

    srcCell.appendChild(targetPiece);
    targetCell.appendChild(piece);

    if (enableCheck.checked) checkPositions();
    else if (isSolved()) finishPuzzle();
  }

  document.querySelectorAll('.cell.drop-target').forEach(el => el.classList.remove('drop-target'));

  touchDrag.piece = null;
  touchDrag.srcCell = null;
  touchDrag.currentTargetCell = null;
}

/* Escape hides overlay */
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && overlay.style.display === 'flex') {
    hideOverlay();
  }
});

/* Initial hint */
message.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É –∏ —Ä–∞–∑–º–µ—Ä –≤ –º–µ–Ω—é —Å–ª–µ–≤–∞. –ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ—é –∫–∞—Ä—Ç–∏–Ω–∫—É.';
</script>

</body>
</html>
