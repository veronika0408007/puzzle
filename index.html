<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Puzzle</title>
<style>
    body {
        font-family: Arial;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        gap: 20px;
    }

    #controls {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 300px;
    }

    #puzzle {
        display: grid;
        gap: 2px;
        touch-action: none;
    }

    .piece {
        background-size: 100% 100%;
        background-repeat: no-repeat;
        border: 1px solid #888;
        width: 100%;
        aspect-ratio: 1;
        touch-action: none;
        user-select: none;
    }

    #preview {
        max-width: 200px;
        border: 2px solid #000;
    }

    @media (max-width: 600px) {
        #puzzle {
            width: 95vw;
        }
    }
</style>
</head>
<body>

<h2>Собери пазл</h2>

<div id="controls">
    <input type="file" id="imgInput">
    <label>Высота (строки): <input type="number" id="rows" value="4" min="2" max="15"></label>
    <label>Ширина (колонки): <input type="number" id="cols" value="4" min="2" max="15"></label>
    <button id="generate">Создать пазл</button>
</div>

<h3>Правильный результат:</h3>
<img id="preview">

<h3 id="timer">Время: 0 сек</h3>

<div id="puzzle"></div>

<script>
let correctOrder = [];
let hasStarted = false;
let timerInterval = null;
let startTime = null;

document.getElementById("generate").onclick = async function () {
    const file = document.getElementById("imgInput").files[0];
    const rows = +document.getElementById("rows").value;
    const cols = +document.getElementById("cols").value;

    if (!file) return alert("Загрузите картинку!");

    const imgURL = URL.createObjectURL(file);
    const preview = document.getElementById("preview");
    preview.src = imgURL;

    const img = await loadImage(imgURL);

    createPuzzle(img, rows, cols);
    startTime = null;
    hasStarted = false;
    document.getElementById("timer").textContent = "Время: 0 сек";
};

function loadImage(src) {
    return new Promise(res => {
        const img = new Image();
        img.onload = () => res(img);
        img.src = src;
    });
}

function createPuzzle(img, rows, cols) {
    const puzzle = document.getElementById("puzzle");
    puzzle.innerHTML = "";
    puzzle.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
    puzzle.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

    const total = rows * cols;

    correctOrder = [...Array(total).keys()];

    let pieces = [];

    for (let i = 0; i < total; i++) {
        const piece = document.createElement("div");
        piece.className = "piece";

        const row = Math.floor(i / cols);
        const col = i % cols;

        const x = -(col * (100 / (cols - 1))) + "%";
        const y = -(row * (100 / (rows - 1))) + "%";

        piece.style.backgroundImage = `url(${img.src})`;
        piece.style.backgroundPosition = `${x} ${y}`;

        piece.dataset.correct = i;

        makeDraggable(piece);

        pieces.push(piece);
    }

    pieces = shuffle(pieces);
    pieces.forEach(p => puzzle.appendChild(p));
}

function shuffle(arr) {
    return arr.sort(() => Math.random() - 0.5);
}

function makeDraggable(piece) {
    piece.draggable = true;

    piece.addEventListener("dragstart", e => {
        e.dataTransfer.setData("index", [...piece.parentNode.children].indexOf(piece));
        if (!hasStarted) startTimer();
    });

    piece.addEventListener("dragover", e => e.preventDefault());

    piece.addEventListener("drop", e => {
        e.preventDefault();

        const puzzle = document.getElementById("puzzle");
        const from = e.dataTransfer.getData("index");
        const to = [...puzzle.children].indexOf(piece);

        swapPieces(from, to);
        checkCorrectPositions();
    });
}

function swapPieces(i, j) {
    const puzzle = document.getElementById("puzzle");
    const pieces = [...puzzle.children];

    if (i === j) return;

    puzzle.insertBefore(pieces[i], pieces[j]);
}

function checkCorrectPositions() {
    const pieces = [...document.getElementById("puzzle").children];
    let solved = true;

    pieces.forEach((p, i) => {
        if (i == p.dataset.correct) {
            p.style.border = "2px solid #00cc00";
        } else {
            p.style.border = "1px solid #cc0000";
            solved = false;
        }
    });

    if (solved) stopTimer();
}

function startTimer() {
    hasStarted = true;
    startTime = Date.now();

    timerInterval = setInterval(() => {
        const sec = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById("timer").textContent = "Время: " + sec + " сек";
    }, 500);
}

function stopTimer() {
    clearInterval(timerInterval);
    const sec = Math.floor((Date.now() - startTime) / 1000);
    document.getElementById("timer").textContent = "Пазл собран! Время: " + sec + " сек";
}
</script>

</body>
</html>
