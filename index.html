<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–∞–∑–ª</title>
<style>
body { font-family: Arial; display: flex; flex-direction: column; align-items: center; padding: 20px; }
#controls { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; }
#puzzle { display: grid; gap: 2px; border: 2px solid #000; padding:5px; }
.piece { background-size: cover; cursor: grab; user-select: none; width: 100px; height: 100px; }
#message { margin-top:12px; font-weight:bold; }
#previewContainer { margin-top:15px; display:none; text-align:center; }
#previewContainer .previewPiece { display:inline-block; width: 100px; height: 100px; background-size: cover; border:2px solid #444; margin:1px; }
</style>
</head>
<body>
<h1>–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–∞–∑–ª</h1>
<div id="controls">
<input type="file" id="imageUpload" accept="image/*" />
<label>–®–∏—Ä–∏–Ω–∞: <input type="number" id="cols" min="2" max="15" value="5" style="width:60px"></label>
<label>–í—ã—Å–æ—Ç–∞: <input type="number" id="rows" min="2" max="15" value="6" style="width:60px"></label>
<label><input type="checkbox" id="enableCheck" checked> –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–∑–∏—Ü–∏–∏ –¥–µ—Ç–∞–ª–µ–π</label>
<button id="generate">–°–æ–∑–¥–∞—Ç—å –ø–∞–∑–ª</button>
<button id="shuffleBtn" disabled>–ü–µ—Ä–µ–º–µ—à–∞—Ç—å</button>
<button id="previewBtn">–ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É</button>
</div>
<div id="previewContainer"><h3>–ö–∞–∫ –¥–æ–ª–∂–Ω–æ –≤—ã–≥–ª—è–¥–µ—Ç—å:</h3><div id="previewPuzzle"></div></div>
<div id="puzzle"></div>
<div id="message"></div>
<h3 id="timer">–í—Ä–µ–º—è: 0 —Å–µ–∫</h3>
<script>
const imgInput = document.getElementById('imageUpload');
const generateBtn = document.getElementById('generate');
const shuffleBtn = document.getElementById('shuffleBtn');
const previewBtn = document.getElementById('previewBtn');
const enableCheck = document.getElementById('enableCheck');
const puzzle = document.getElementById('puzzle');
const previewContainer = document.getElementById('previewContainer');
const previewPuzzle = document.getElementById('previewPuzzle');
const message = document.getElementById('message');
const timerDisplay = document.getElementById('timer');

let imageURL = '';
let piecesData = [];
let startTime = null;
let timerInterval = null;
let hasStarted = false;
let cols=5, rows=6;

imgInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if(file) {
    imageURL = URL.createObjectURL(file);
  }
});

previewBtn.addEventListener('click', () => {
  if(!imageURL) return alert('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
  renderPreview();
  previewContainer.style.display = 'block';
});

generateBtn.addEventListener('click', () => {
  if(!imageURL) return alert('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
  cols = parseInt(document.getElementById('cols').value);
  rows = parseInt(document.getElementById('rows').value);

  puzzle.innerHTML = '';
  puzzle.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
  puzzle.style.gridTemplateRows = `repeat(${rows}, 1fr)`;

  piecesData = [];
  const total = cols*rows;
  for(let i=0;i<total;i++){
    const piece = document.createElement('div');
    piece.className='piece';
    const row=Math.floor(i/cols);
    const col=i%cols;
    piece.style.backgroundImage=`url(${imageURL})`;
    piece.style.backgroundSize=`${cols*100}% ${rows*100}%`;
    piece.style.backgroundPosition=`${(col/(cols-1))*100}% ${(row/(rows-1))*100}%`;
    piece.dataset.correct=i;
    piece.dataset.current=i;
    makeDraggable(piece);
    piecesData.push(piece);
  }

  shufflePieces();
  hasStarted=false;
  startTime=null;
  clearInterval(timerInterval);
  timerDisplay.textContent='–í—Ä–µ–º—è: 0 —Å–µ–∫';
});

shuffleBtn.addEventListener('click', shufflePieces);

function shufflePieces(){
  const pieces = [...piecesData];
  pieces.sort(()=>Math.random()-0.5);
  puzzle.innerHTML='';
  pieces.forEach((p,i)=>{ p.dataset.current=i; puzzle.appendChild(p); });
  shuffleBtn.disabled=false;
  message.textContent='';
}

function makeDraggable(piece){
  piece.draggable=true;
  piece.addEventListener('dragstart', e=>{
    e.dataTransfer.setData('index',[...puzzle.children].indexOf(piece));
    if(!hasStarted) startTimer();
  });
  piece.addEventListener('dragover', e=>e.preventDefault());
  piece.addEventListener('drop', e=>{
    e.preventDefault();
    const from=[...puzzle.children].indexOf(piecesData[e.dataTransfer.getData('index')]);
    const to=[...puzzle.children].indexOf(e.target);
    swapPieces(from,to);
    if(enableCheck.checked) checkPositions();
    else if(isPuzzleSolved()) stopTimer();
  });
}

function swapPieces(i,j){
  const children=[...puzzle.children];
  if(i===j) return;
  puzzle.insertBefore(children[i],children[j]);
  puzzle.insertBefore(children[j],children[i+1]||null);
  children[i].dataset.current=i;
  children[j].dataset.current=j;
}

function checkPositions(){
  const children=[...puzzle.children];
  let solved=true;
  children.forEach((p,i)=>{
    if(parseInt(p.dataset.correct)===i){
      p.style.border='2px solid green';
    } else {
      p.style.border='2px solid red';
      solved=false;
    }
  });
  message.textContent=solved?'–ü–∞–∑–ª —Å–æ–±—Ä–∞–Ω! üéâ':'';
  if(solved) stopTimer();
}

function isPuzzleSolved(){
  return [...puzzle.children].every((p,i)=>parseInt(p.dataset.correct)===i);
}

function startTimer(){
  hasStarted=true;
  startTime=Date.now();
  timerInterval=setInterval(()=>{
    const sec=Math.floor((Date.now()-startTime)/1000);
    timerDisplay.textContent='–í—Ä–µ–º—è: '+sec+' —Å–µ–∫';
  },500);
}

function stopTimer(){
  clearInterval(timerInterval);
  const sec=Math.floor((Date.now()-startTime)/1000);
  timerDisplay.textContent='–ü–∞–∑–ª —Å–æ–±—Ä–∞–Ω! –í—Ä–µ–º—è: '+sec+' —Å–µ–∫';
}

function renderPreview(){
  previewPuzzle.innerHTML='';
  for(let i=0;i<cols*rows;i++){
    const div=document.createElement('div');
    const row=Math.floor(i/cols);
    const col=i%cols;
    div.className='previewPiece';
    div.style.backgroundImage=`url(${imageURL})`;
    div.style.backgroundSize=`${cols*100}% ${rows*100}%`;
    div.style.backgroundPosition=`${(col/(cols-1))*100}% ${(row/(rows-1))*100}%`;
    previewPuzzle.appendChild(div);
  }
}
</script>
</body>
</html>
