<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–∞–∑–ª</title>
<style>
body {
  font-family: Arial;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px;
}
#controls { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; }
#puzzle { display: grid; gap: 2px; border: 2px solid #000; padding:5px; }
.piece { background-size: cover; cursor: grab; user-select: none; }
#message { margin-top:12px; font-weight:bold; }
#previewContainer { margin-top:15px; display:none; text-align:center; }
#previewContainer img { max-width:300px; border:2px solid #444; }
</style>
</head>
<body>
<h1>–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–∞–∑–ª</h1>
<div id="controls">
  <input type="file" id="imageUpload" accept="image/*" />
  <label>–®–∏—Ä–∏–Ω–∞: <input type="number" id="cols" min="2" max="15" value="5" style="width:60px"></label>
  <label>–í—ã—Å–æ—Ç–∞: <input type="number" id="rows" min="2" max="15" value="6" style="width:60px"></label>
  <button id="generate">–°–æ–∑–¥–∞—Ç—å –ø–∞–∑–ª</button>
  <button id="shuffleBtn" disabled>–ü–µ—Ä–µ–º–µ—à–∞—Ç—å</button>
  <button id="previewBtn">–ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É</button>
</div>
<div id="previewContainer"><h3>–ö–∞–∫ –¥–æ–ª–∂–Ω–æ –≤—ã–≥–ª—è–¥–µ—Ç—å:</h3><img id="previewImg"></div>
<div id="puzzle"></div>
<div id="message"></div>
<h3 id="timer">–í—Ä–µ–º—è: 0 —Å–µ–∫</h3>
<script>
const imgInput = document.getElementById('imageUpload');
const generateBtn = document.getElementById('generate');
const shuffleBtn = document.getElementById('shuffleBtn');
const previewBtn = document.getElementById('previewBtn');
const puzzle = document.getElementById('puzzle');
const previewContainer = document.getElementById('previewContainer');
const previewImg = document.getElementById('previewImg');
const message = document.getElementById('message');
const timerDisplay = document.getElementById('timer');

let imageURL = '';
let correctOrder = [];
let startTime = null;
let timerInterval = null;
let hasStarted = false;

imgInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if(file) {
    imageURL = URL.createObjectURL(file);
    previewImg.src = imageURL;
  }
});

previewBtn.addEventListener('click', () => {
  if(!imageURL) return alert('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
  previewContainer.style.display = 'block';
});

generateBtn.addEventListener('click', () => {
  if(!imageURL) return alert('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
  const cols = parseInt(document.getElementById('cols').value);
  const rows = parseInt(document.getElementById('rows').value);

  puzzle.innerHTML = '';
  puzzle.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
  puzzle.style.gridTemplateRows = `repeat(${rows}, 1fr)`;

  correctOrder = [];
  let total = cols*rows;
  let pieces = [];

  for(let i=0;i<total;i++){
    const piece = document.createElement('div');
    piece.className='piece';
    const row=Math.floor(i/cols);
    const col=i%cols;
    piece.style.backgroundImage=`url(${imageURL})`;
    piece.style.backgroundSize=`${cols*100}% ${rows*100}%`;
    piece.style.backgroundPosition=`${(col/(cols-1))*100}% ${(row/(rows-1))*100}%`;
    piece.dataset.correct=i;
    makeDraggable(piece);
    pieces.push(piece);
    correctOrder.push(i);
  }

  pieces = shuffle(pieces);
  pieces.forEach(p=>puzzle.appendChild(p));
  shuffleBtn.disabled=false;

  hasStarted=false;
  startTime=null;
  clearInterval(timerInterval);
  timerDisplay.textContent='–í—Ä–µ–º—è: 0 —Å–µ–∫';
});

shuffleBtn.addEventListener('click', () => {
  const pieces=[...puzzle.children];
  pieces.sort(()=>Math.random()-0.5);
  puzzle.innerHTML='';
  pieces.forEach(p=>puzzle.appendChild(p));
  message.textContent='';
});

function makeDraggable(piece){
  piece.draggable=true;
  piece.addEventListener('dragstart', e=>{
    e.dataTransfer.setData('index',[...puzzle.children].indexOf(piece));
    if(!hasStarted) startTimer();
  });
  piece.addEventListener('dragover', e=>e.preventDefault());
  piece.addEventListener('drop', e=>{
    e.preventDefault();
    const from = e.dataTransfer.getData('index');
    const to = [...puzzle.children].indexOf(e.target);
    swapPieces(from,to);
    checkSolved();
  });
}

function swapPieces(i,j){
  const pieces=[...puzzle.children];
  if(i===j) return;
  puzzle.insertBefore(pieces[i],pieces[j]);
  puzzle.insertBefore(pieces[j],pieces[i+1]||null);
}

function checkSolved(){
  const items=[...puzzle.children];
  let solved=true;
  items.forEach((p,i)=>{ if(p.dataset.correct!=i) solved=false; });
  message.textContent=solved?'–ü–∞–∑–ª —Å–æ–±—Ä–∞–Ω! üéâ':'';
  if(solved) stopTimer();
}

function shuffle(array){return array.sort(()=>Math.random()-0.5);}

function startTimer(){
  hasStarted=true;
  startTime=Date.now();
  timerInterval=setInterval(()=>{
    const sec=Math.floor((Date.now()-startTime)/1000);
    timerDisplay.textContent='–í—Ä–µ–º—è: '+sec+' —Å–µ–∫';
  },500);
}

function stopTimer(){
  clearInterval(timerInterval);
  const sec=Math.floor((Date.now()-startTime)/1000);
  timerDisplay.textContent='–ü–∞–∑–ª —Å–æ–±—Ä–∞–Ω! –í—Ä–µ–º—è: '+sec+' —Å–µ–∫';
}
</script>
</body>
</html>
