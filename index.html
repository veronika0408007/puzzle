<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–∞–∑–ª</title>

<style>
body {
  font-family: Arial;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px;
}

#controls {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 20px;
}

#puzzle {
  display: grid;
  gap: 2px;
  border: 2px solid #000;
  padding: 5px;
}

.piece {
  background-size: cover;
  cursor: grab;
  user-select: none;
}

#message {
  margin-top: 12px;
  font-weight: bold;
}

#previewContainer {
  margin-top: 15px;
  display: none;
  text-align: center;
}

.previewPiece {
  display: inline-block;
  border: 2px solid #444;
  margin: 1px;
  background-size: cover;
}
</style>
</head>

<body>

<h1>–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–∞–∑–ª</h1>

<div id="controls">
  <input type="file" id="imageUpload" accept="image/*">
  <label>–®–∏—Ä–∏–Ω–∞:
    <input type="number" id="cols" min="1" max="20" value="1" style="width:60px">
  </label>
  <label>–í—ã—Å–æ—Ç–∞:
    <input type="number" id="rows" min="1" max="20" value="1" style="width:60px">
  </label>
  <label>
    <input type="checkbox" id="enableCheck" checked>
    –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–∑–∏—Ü–∏–∏ –¥–µ—Ç–∞–ª–µ–π
  </label>
  <button id="generate">–°–æ–∑–¥–∞—Ç—å –ø–∞–∑–ª</button>
  <button id="shuffleBtn" disabled>–ü–µ—Ä–µ–º–µ—à–∞—Ç—å</button>
  <button id="previewBtn">–ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É</button>
</div>

<div id="previewContainer">
  <h3>–ö–∞–∫ –¥–æ–ª–∂–Ω–æ –≤—ã–≥–ª—è–¥–µ—Ç—å:</h3>
  <div id="previewPuzzle"></div>
</div>

<div id="puzzle"></div>
<div id="message"></div>
<h3 id="timer">–í—Ä–µ–º—è: 0 </h3>

<script>
const imgInput = document.getElementById('imageUpload');
const generateBtn = document.getElementById('generate');
const shuffleBtn = document.getElementById('shuffleBtn');
const previewBtn = document.getElementById('previewBtn');
const enableCheck = document.getElementById('enableCheck');
const puzzle = document.getElementById('puzzle');
const previewContainer = document.getElementById('previewContainer');
const previewPuzzle = document.getElementById('previewPuzzle');
const message = document.getElementById('message');
const timerDisplay = document.getElementById('timer');

let imageURL = '';
let pieces = [];
let cols = 5, rows = 6;
let pieceWidth = 100, pieceHeight = 100;

let selectedPiece = null;
let started = false;
let startTime = null;
let timer = null;

/* ===== –ó–ê–ì–†–£–ó–ö–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø ===== */
imgInput.addEventListener('change', e => {
  if (e.target.files[0]) {
    imageURL = URL.createObjectURL(e.target.files[0]);
  }
});

/* ===== –°–û–ó–î–ê–ù–ò–ï –ü–ê–ó–õ–ê ===== */
generateBtn.addEventListener('click', () => {
  if (!imageURL) return alert('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');

  cols = +document.getElementById('cols').value;
  rows = +document.getElementById('rows').value;

  pieceWidth = Math.floor(500 / cols);
  pieceHeight = Math.floor(500 / rows);

  puzzle.style.gridTemplateColumns = `repeat(${cols}, ${pieceWidth}px)`;
  puzzle.style.gridTemplateRows = `repeat(${rows}, ${pieceHeight}px)`;

  puzzle.innerHTML = '';
  pieces = [];
  selectedPiece = null;

  for (let i = 0; i < cols * rows; i++) {
    const piece = document.createElement('div');
    piece.className = 'piece';
    piece.style.width = pieceWidth + 'px';
    piece.style.height = pieceHeight + 'px';

    const r = Math.floor(i / cols);
    const c = i % cols;

    piece.style.backgroundImage = `url(${imageURL})`;
    piece.style.backgroundSize = `${pieceWidth * cols}px ${pieceHeight * rows}px`;
    piece.style.backgroundPosition =
      `-${c * pieceWidth}px -${r * pieceHeight}px`;

    piece.dataset.correct = i;

    piece.addEventListener('click', () => selectPiece(piece));

    pieces.push(piece);
  }

  shuffle();
  resetTimer();
});

/* ===== –ü–ï–†–ï–ú–ï–®–ò–í–ê–ù–ò–ï ===== */
shuffleBtn.addEventListener('click', shuffle);

function shuffle() {
  pieces.sort(() => Math.random() - 0.5);
  redrawPuzzle();
  message.textContent = '';
}

/* ===== –í–´–ë–û–† –î–ï–¢–ê–õ–ò ===== */
function selectPiece(piece) {
  if (selectedPiece) selectedPiece.classList.remove('selected');
  selectedPiece = piece;
  piece.classList.add('selected');

  if (!started) startTimer();
}

/* ===== –ö–õ–ò–ö –ü–û –ü–ê–ó–õ–£ ===== */
puzzle.addEventListener('click', e => {
  if (!selectedPiece) return;

  const rect = puzzle.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  const col = Math.floor(x / pieceWidth);
  const row = Math.floor(y / pieceHeight);

  if (col < 0 || col >= cols || row < 0 || row >= rows) return;

  const targetIndex = row * cols + col;
  const fromIndex = pieces.indexOf(selectedPiece);
  if (fromIndex === targetIndex) return;

  [pieces[fromIndex], pieces[targetIndex]] =
  [pieces[targetIndex], pieces[fromIndex]];

  selectedPiece.classList.remove('selected');
  selectedPiece = null;

  redrawPuzzle();

  if (enableCheck.checked) checkPositions();
  else if (isSolved()) finishPuzzle();
});

/* ===== –ü–ï–†–ï–†–ò–°–û–í–ö–ê ===== */
function redrawPuzzle() {
  puzzle.innerHTML = '';
  pieces.forEach(p => puzzle.appendChild(p));
}

/* ===== –ü–†–û–í–ï–†–ö–ê ===== */
function checkPositions() {
  let solved = true;

  pieces.forEach((p, i) => {
    if (+p.dataset.correct === i) {
      p.style.border = '2px solid green';
    } else {
      p.style.border = '2px solid red';
      solved = false;
    }
  });

  if (solved) finishPuzzle();
}

function isSolved() {
  return pieces.every((p, i) => +p.dataset.correct === i);
}

/* ===== –§–ò–ù–ò–® ===== */
function finishPuzzle() {
  stopTimer();
  message.textContent = '–ü–∞–∑–ª —Å–æ–±—Ä–∞–Ω! üéâ';
}

/* ===== –¢–ê–ô–ú–ï–† (–º–º:—Å—Å:–º—Å) ===== */
function startTimer() {
  started = true;
  startTime = performance.now();

  timer = setInterval(() => {
    const t = performance.now() - startTime;

    const ms = Math.floor(t % 1000).toString().padStart(3, '0');
    const sec = Math.floor(t / 1000) % 60;
    const min = Math.floor(t / 60000);

    timerDisplay.textContent =
      `–í—Ä–µ–º—è: ${min}:${sec.toString().padStart(2,'0')}:${ms}`;
  }, 50);
}

function stopTimer() {
  clearInterval(timer);
}

function resetTimer() {
  clearInterval(timer);
  started = false;
  timerDisplay.textContent = '–í—Ä–µ–º—è: 0:00:000';
}

/* ===== –ü–†–ï–í–¨–Æ (–ß–Å–¢–ö–û–ï) ===== */
previewBtn.addEventListener('click', () => {
  if (!imageURL) return alert('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
  renderPreview();
  previewContainer.style.display = 'block';
});

function renderPreview() {
  previewPuzzle.innerHTML = '';
  previewPuzzle.style.width = pieceWidth * cols + 'px';
  previewPuzzle.style.height = pieceHeight * rows + 'px';

  for (let i = 0; i < cols * rows; i++) {
    const div = document.createElement('div');
    div.className = 'previewPiece';
    div.style.width = pieceWidth + 'px';
    div.style.height = pieceHeight + 'px';

    const r = Math.floor(i / cols);
    const c = i % cols;

    div.style.backgroundImage = `url(${imageURL})`;
    div.style.backgroundSize = `${pieceWidth * cols}px ${pieceHeight * rows}px`;
    div.style.backgroundPosition =
      `-${c * pieceWidth}px -${r * pieceHeight}px`;

    previewPuzzle.appendChild(div);
  }
}
</script>


</body>
</html>
