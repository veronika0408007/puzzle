<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–∞–∑–ª ‚Äî –∞–∫–∫–∞—É–Ω—Ç—ã —Å –∞–≤–∞—Ç–∞—Ä–∫–æ–π</title>
<style>
:root { --card-bg:#fff; --accent:#2196f3; --muted:#666; --danger:#e53935; }
body{ font-family:Arial,Helvetica,sans-serif; margin:0; padding:18px; background:#f5f5f5; min-height:100vh; }
header{ width:100%; max-width:1100px; margin:0 auto 12px; display:flex; align-items:center; gap:12px; }
h1{ margin:0; font-size:1.1rem; }
#topControls{ margin-left:auto; display:flex; gap:8px; align-items:center; }
.btn{ padding:8px 12px; border-radius:6px; border:1px solid #ddd; background:var(--card-bg); cursor:pointer; font-size:0.95rem; }
.btn.primary{ background:var(--accent); color:#fff; border-color:#1976d2; }
.avatar-small { width:30px; height:30px; border-radius:50%; object-fit:cover; margin-right:8px; vertical-align:middle; border:1px solid #ccc; }

/* main area */
main{ width:100%; max-width:1100px; margin:0 auto; display:flex; gap:14px; align-items:flex-start; }
#puzzleArea{ flex:1; display:flex; flex-direction:column; gap:12px; }
#controls{ background:var(--card-bg); padding:10px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.06); display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
#puzzle{ display:grid; gap:2px; border:2px solid #000; padding:5px; background:#fafafa; touch-action:none; }
.cell{ position:relative; overflow:hidden; background:#eee; }
.piece{ width:100%; height:100%; background-size:cover; cursor:grab; user-select:none; transition:transform .15s, border-color .12s; box-sizing:border-box; border:2px solid transparent; }
.piece.dragging{ opacity:.6; cursor:grabbing; transform:scale(1.02); z-index:10; }
.piece.selected{ outline:3px dashed #666; }
.cell.drop-target{ box-shadow:inset 0 0 0 3px rgba(0,120,215,0.18); }

.previewPiece{ box-sizing:border-box; border:2px solid #44444a; width:100%; height:100%; background-size:cover; }

.overlay{ position:fixed; inset:0; display:none; background:rgba(0,0,0,.45); align-items:center; justify-content:center; z-index:2100; padding:18px; }
.panel{ width:760px; max-width:95%; background:var(--card-bg); border-radius:8px; padding:14px; box-shadow:0 10px 40px rgba(0,0,0,.2); }
.panel.small{ width:420px; max-width:92%; }

.form-row{ display:flex; flex-direction:column; gap:6px; margin-bottom:8px; }
.form-row.inline{ flex-direction:row; gap:8px; align-items:center; }
.input{ padding:8px; border:1px solid #ccc; border-radius:6px; width:100%; box-sizing:border-box; }

.account-tabs{ display:flex; gap:8px; margin-bottom:10px; }
.tab{ padding:8px 12px; border-radius:6px; background:#f3f3f3; cursor:pointer; border:1px solid #e6e6e6; }
.tab.active{ background:var(--accent); color:#fff; border-color:#1976d2; }

.statsTable{ width:100%; border-collapse:collapse; margin-top:8px; font-size:0.95rem; }
.statsTable th, .statsTable td{ padding:6px 8px; border-bottom:1px solid #eee; text-align:left; }

.preview-grid { display:grid; gap:2px; border:2px solid #444; padding:5px; background:#fff; }

small { color:var(--muted); }

@media(max-width:800px){ .panel{ width:92%; } .panel.small{ width:92%; } }
</style>
</head>
<body>

<header>
  <h1>–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–∞–∑–ª</h1>
  <div id="topControls">
    <button id="menuToggleBtn" class="btn">–ú–µ–Ω—é</button>
    <button id="previewBtn" class="btn">–ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É</button>
    <button id="shuffleBtn" class="btn" disabled>–ü–µ—Ä–µ–º–µ—à–∞—Ç—å</button>
    <button id="accountBtn" class="btn">–ê–∫–∫–∞—É–Ω—Ç</button>
  </div>
</header>

<main>
  <div id="puzzleArea">
    <div id="controls" aria-label="–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è">
      <input type="file" id="imageUpload" accept="image/*" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É">
      <label style="display:flex;align-items:center;gap:6px;">
        <input type="checkbox" id="enableCheck" checked> –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–∑–∏—Ü–∏–∏
      </label>
      <small style="margin-left:auto;">–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –ø–ª–∏—Ç–∫–∏ –∏–ª–∏ –∫–ª–∏–∫–∞–π—Ç–µ –¥–ª—è –æ–±–º–µ–Ω–∞</small>
    </div>

    <div id="puzzle" aria-label="–ü–æ–ª–µ –ø–∞–∑–ª–∞"></div>

    <div id="previewContainer" style="display:none;">
      <h3 style="margin:8px 0 6px;">–ö–∞–∫ –¥–æ–ª–∂–Ω–æ –≤—ã–≥–ª—è–¥–µ—Ç—å:</h3>
      <div id="previewPuzzle" class="preview-grid"></div>
    </div>

    <div id="message" aria-live="polite">–ù–∞–∂–º–∏—Ç–µ ¬´–ú–µ–Ω—é¬ª, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É –∏ —Ä–∞–∑–º–µ—Ä. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.</div>
    <h3 id="timer">–í—Ä–µ–º—è: 0:00:000</h3>
  </div>
</main>

<!-- Menu overlay -->
<div id="menuOverlay" class="overlay" aria-hidden="true">
  <div class="panel" role="document">
    <div style="display:flex;gap:12px;">
      <div style="width:240px;">
        <h3 style="margin:0 0 8px 0;">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É</h3>
        <div id="presetList"></div>
        <div style="margin-top:8px;">
          <label>–ò–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–≤–æ—é</label>
          <input type="file" id="menuUpload" accept="image/*" style="width:100%;margin-top:6px;">
        </div>
      </div>
      <div style="flex:1; display:flex; flex-direction:column;">
        <h3 style="margin:0;">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ä</h3>
        <div style="display:flex;gap:8px;margin:8px 0;" id="presetSizes">
          <button class="btn" data-cols="3" data-rows="3">3√ó3</button>
          <button class="btn primary" data-cols="5" data-rows="6">5√ó6</button>
          <button class="btn" data-cols="8" data-rows="6">8√ó6</button>
          <button class="btn" data-cols="10" data-rows="8">10√ó8</button>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <label>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π:
            <input type="number" id="menuCols" value="5" min="1" max="30" style="width:70px;margin-left:6px">
            √ó
            <input type="number" id="menuRows" value="6" min="1" max="30" style="width:70px;margin-left:6px">
          </label>
        </div>
        <div style="margin-top:auto; display:flex;gap:8px;">
          <button id="menuCreate" class="btn primary">–°–æ–∑–¥–∞—Ç—å –ø–∞–∑–ª</button>
          <button id="menuUseUploaded" class="btn">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ</button>
          <button id="menuClose" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Complete overlay -->
<div id="completeOverlay" class="overlay" aria-hidden="true">
  <div class="panel small">
    <h2>–£—Ä–∞! –ü–∞–∑–ª —Å–æ–±—Ä–∞–Ω üéâ</h2>
    <p id="completeTime">–í—Ä–µ–º—è: 0:00:000</p>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:8px;">
      <button id="completeShuffle" class="btn">–ü–µ—Ä–µ–º–µ—à–∞—Ç—å</button>
      <button id="completeNew" class="btn primary">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–∞–∑–ª</button>
      <button id="completeClose" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div style="margin-top:8px;"><small>–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –≤–∞—à–µ–º –ø—Ä–æ—Ñ–∏–ª–µ, –µ—Å–ª–∏ –≤—ã –≤–æ—à–ª–∏.</small></div>
  </div>
</div>

<!-- Account overlay -->
<div id="accountOverlay" class="overlay" aria-hidden="true">
  <div class="panel small" role="document">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3 style="margin:0;">–ê–∫–∫–∞—É–Ω—Ç</h3>
      <button id="accountClose" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div class="account-tabs" role="tablist" aria-label="–ê–∫–∫–∞—É–Ω—Ç">
      <div id="tabLogin" class="tab active" role="tab">–í–æ–π—Ç–∏</div>
      <div id="tabRegister" class="tab" role="tab">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
      <div id="tabProfile" class="tab" role="tab">–ü—Ä–æ—Ñ–∏–ª—å</div>
      <div id="tabStats" class="tab" role="tab">–ú–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</div>
    </div>

    <!-- LOGIN -->
    <div id="paneLogin">
      <div class="form-row"><label>–ü–æ—á—Ç–∞</label><input id="loginEmail" class="input" type="email"></div>
      <div class="form-row"><label>–ü–∞—Ä–æ–ª—å</label><input id="loginPassword" class="input" type="password"></div>
      <div style="display:flex;gap:8px;">
        <button id="loginBtn" class="btn primary">–í–æ–π—Ç–∏</button>
        <button id="goToRegister" class="btn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      </div>
      <div id="loginMsg" style="margin-top:8px;color:var(--muted)"></div>
    </div>

    <!-- REGISTER -->
    <div id="paneRegister" style="display:none;">
      <div class="form-row"><label>–ü–æ—á—Ç–∞</label><input id="regEmail" class="input" type="email"></div>
      <div class="form-row"><label>–ù–∏–∫–Ω–µ–π–º</label><input id="regNick" class="input" type="text" maxlength="30"></div>
      <div class="form-row inline">
        <div style="flex:1;"><label>–í–æ–∑—Ä–∞—Å—Ç</label><input id="regAge" class="input" type="number" min="1" max="120"></div>
        <div style="flex:1;"><label>–ü–∞—Ä–æ–ª—å</label><input id="regPassword" class="input" type="password"></div>
      </div>
      <div class="form-row"><label>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label><input id="regPassword2" class="input" type="password"></div>

      <div class="form-row">
        <label>–ê–≤–∞—Ç–∞—Ä (jpg/png, –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <input id="regAvatar" type="file" accept="image/*">
        <img id="regAvatarPreview" src="" alt="–ü—Ä–µ–≤—å—é –∞–≤–∞—Ç–∞—Ä–∞" style="display:none;width:72px;height:72px;border-radius:8px;border:1px solid #ccc;margin-top:6px;object-fit:cover;">
      </div>

      <div style="display:flex;gap:8px;">
        <button id="regBtn" class="btn primary">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        <button id="regCancel" class="btn">–û—Ç–º–µ–Ω–∞</button>
      </div>
      <div id="regMsg" style="margin-top:8px;color:var(--muted)"></div>
    </div>

    <!-- PROFILE -->
    <div id="paneProfile" style="display:none;">
      <div id="profileInfo" style="margin-bottom:8px;color:var(--muted)"></div>

      <div style="display:flex;gap:8px;align-items:center;">
        <img id="profileAvatarImg" src="" alt="–ê–≤–∞—Ç–∞—Ä" style="width:72px;height:72px;border-radius:10px;border:1px solid #ccc;object-fit:cover;display:none;">
        <div style="flex:1;">
          <label>–ò–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</label>
          <input id="profileAvatarInput" type="file" accept="image/*">
          <div style="display:flex;gap:8px;margin-top:8px;">
            <button id="saveAvatarBtn" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</button>
            <button id="logoutBtn" class="btn">–í—ã–π—Ç–∏</button>
          </div>
          <div id="profileMsg" style="margin-top:8px;color:var(--muted)"></div>
        </div>
      </div>

      <div style="margin-top:8px;">
        <label>–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–¥–µ–º–æ):</label>
        <div style="display:flex;gap:8px;margin-top:6px;">
          <input id="confirmCodeInput" class="input" placeholder="–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è">
          <button id="confirmCodeBtn" class="btn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <!-- STATS -->
    <div id="paneStats" style="display:none;">
      <div id="statsSummary" style="color:var(--muted)"></div>
      <table class="statsTable" id="statsTable">
        <thead><tr><th>–ö–∞—Ä—Ç–∏–Ω–∫–∞</th><th>–†–∞–∑–º–µ—Ä</th><th>–í—Ä–µ–º—è</th><th>–î–∞—Ç–∞</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

  </div>
</div>

<script>
/* --------- Utilities --------- */
function $(id){ return document.getElementById(id); }
function formatTime(ms){
  const m = Math.floor(ms/60000);
  const s = Math.floor(ms/1000)%60;
  const msr = Math.floor(ms%1000).toString().padStart(3,'0');
  return `${m}:${s.toString().padStart(2,'0')}:${msr}`;
}
async function sha256Hex(text){
  const enc = new TextEncoder().encode(text);
  const hash = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* --------- Storage helpers --------- */
const STORAGE_USERS = 'puzzle_users_v2';
const STORAGE_CURRENT = 'puzzle_current_user';

function loadUsers(){ try{ return JSON.parse(localStorage.getItem(STORAGE_USERS) || '{}'); }catch(e){ return {}; } }
function saveUsers(users){ localStorage.setItem(STORAGE_USERS, JSON.stringify(users)); }
function setCurrentUser(email){ if(email) localStorage.setItem(STORAGE_CURRENT, email); else localStorage.removeItem(STORAGE_CURRENT); }
function getCurrentUserEmail(){ return localStorage.getItem(STORAGE_CURRENT); }
function getCurrentUser(){ const e=getCurrentUserEmail(); if(!e) return null; const u=loadUsers()[e]; return u || null; }

/* --------- Demo presets --------- */
const presets = [
  { id:'p1', title:'–ì–æ—Ä—ã', url:'https://images.unsplash.com/photo-1501785888041-af3ef285b470?q=80&w=1200&auto=format&fit=crop' },
  { id:'p2', title:'–ì–æ—Ä–æ–¥', url:'https://images.unsplash.com/photo-1491553895911-0055eca6402d?q=80&w=1200&auto=format&fit=crop' },
  { id:'p3', title:'–ü—Ç–∏—Ü–∞', url:'https://images.unsplash.com/photo-1507149833265-60c372daea22?q=80&w=1200&auto=format&fit=crop' },
  { id:'p4', title:'–ê–±—Å—Ç—Ä–∞–∫—Ç', url:'https://images.unsplash.com/photo-1504198453319-5ce911bafcde?q=80&w=1200&auto=format&fit=crop' }
];

/* --------- DOM refs --------- */
const menuToggleBtn = $('menuToggleBtn'), menuOverlay = $('menuOverlay'), presetList = $('presetList'),
      menuUpload = $('menuUpload'), menuCreate = $('menuCreate'), menuUseUploaded = $('menuUseUploaded'), menuClose = $('menuClose'),
      presetSizes = $('presetSizes'), menuCols = $('menuCols'), menuRows = $('menuRows');

const imageUpload = $('imageUpload'), previewBtn = $('previewBtn'), shuffleBtn = $('shuffleBtn'), enableCheckEl = $('enableCheck'),
      puzzleEl = $('puzzle'), previewContainer = $('previewContainer'), previewPuzzle = $('previewPuzzle'),
      messageEl = $('message'), timerDisplay = $('timer'), completeOverlay = $('completeOverlay');

const accountBtn = $('accountBtn'), accountOverlay = $('accountOverlay'), accountClose = $('accountClose'),
      tabLogin = $('tabLogin'), tabRegister = $('tabRegister'), tabProfile = $('tabProfile'), tabStats = $('tabStats'),
      paneLogin = $('paneLogin'), paneRegister = $('paneRegister'), paneProfile = $('paneProfile'), paneStats = $('paneStats');

const loginEmail = $('loginEmail'), loginPassword = $('loginPassword'), loginBtn = $('loginBtn'), loginMsg = $('loginMsg'), goToRegister = $('goToRegister');

const regEmail = $('regEmail'), regNick = $('regNick'), regAge = $('regAge'),
      regPassword = $('regPassword'), regPassword2 = $('regPassword2'), regBtn = $('regBtn'), regMsg = $('regMsg'),
      regAvatar = $('regAvatar'), regAvatarPreview = $('regAvatarPreview'), regCancel = $('regCancel');

const profileInfo = $('profileInfo'), profileAvatarImg = $('profileAvatarImg'),
      profileAvatarInput = $('profileAvatarInput'), saveAvatarBtn = $('saveAvatarBtn'),
      logoutBtn = $('logoutBtn'), profileMsg = $('profileMsg'),
      confirmCodeInput = $('confirmCodeInput'), confirmCodeBtn = $('confirmCodeBtn');

const statsSummary = $('statsSummary'), statsTableBody = $('statsTable').querySelector('tbody');

const completeTime = $('completeTime'), completeShuffle = $('completeShuffle'), completeNew = $('completeNew'), completeClose = $('completeClose');

/* --------- App state --------- */
let selectedPreset = presets[0]; let uploadedURL = ''; let imageURL = selectedPreset.url; let imageId = selectedPreset.id;
let cols = 5, rows = 6, pieceWidth = 100, pieceHeight = 100;
let cells = [], started=false, startTime=null, timer=null, pieceIdCounter=0, solvedAlready=false, selectedPiece=null;
let currentPuzzleMeta = null;

/* --------- Build presets UI --------- */
function buildPresetThumbnails(){
  presetList.innerHTML = '';
  presets.forEach(p=>{
    const el = document.createElement('div'); el.className='presetItem'; el.style.margin='6px 0'; el.innerHTML = `<img src="${p.url}" alt="" style="width:100%;height:72px;object-fit:cover;border-radius:6px;"><div style="text-align:center;margin-top:6px">${p.title}</div>`;
    el.addEventListener('click', ()=>{ document.querySelectorAll('.presetItem').forEach(i=>i.style.border='none'); el.style.border=`2px solid ${getComputedStyle(document.documentElement).getPropertyValue('--accent')}`; selectedPreset=p; imageURL=p.url; imageId=p.id; });
    presetList.appendChild(el);
  });
  // select first
  if(presetList.firstChild){ presetList.firstChild.style.border=`2px solid ${getComputedStyle(document.documentElement).getPropertyValue('--accent')}`; selectedPreset=presets[0]; imageURL=presets[0].url; imageId=presets[0].id; }
}
buildPresetThumbnails();

/* preset size buttons */
presetSizes.querySelectorAll('button').forEach(btn=>{
  btn.addEventListener('click', ()=>{ presetSizes.querySelectorAll('button').forEach(b=>b.classList.remove('primary')); btn.classList.add('primary'); menuCols.value = btn.dataset.cols; menuRows.value = btn.dataset.rows; });
});

/* menu toggle */
function openMenu(){ menuOverlay.style.display='flex'; menuOverlay.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
function closeMenu(){ menuOverlay.style.display='none'; menuOverlay.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }
menuToggleBtn.addEventListener('click', ()=> menuOverlay.style.display==='flex' ? closeMenu() : openMenu() );
menuClose.addEventListener('click', closeMenu);
menuOverlay.addEventListener('click', e=>{ if(e.target===menuOverlay) closeMenu(); });

/* menu upload */
menuUpload.addEventListener('change', e=>{
  const f = e.target.files && e.target.files[0]; if(!f) return;
  if(uploadedURL) URL.revokeObjectURL(uploadedURL);
  uploadedURL = URL.createObjectURL(f);
  imageURL = uploadedURL; imageId = 'uploaded:'+uploadedURL;
  // unselect presets
  document.querySelectorAll('.presetItem').forEach(i=>i.style.border='none');
});

/* quick upload */
imageUpload.addEventListener('change', e=>{
  const f = e.target.files && e.target.files[0]; if(!f) return;
  if(uploadedURL) URL.revokeObjectURL(uploadedURL);
  uploadedURL = URL.createObjectURL(f);
  imageURL = uploadedURL; imageId = 'uploaded:'+uploadedURL;
  messageEl.textContent = '–ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –û—Ç–∫—Ä–æ–π—Ç–µ –º–µ–Ω—é –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–æ–∑–¥–∞—Ç—å –ø–∞–∑–ª¬ª.';
});

/* menu actions */
$('menuUseUploaded').addEventListener('click', ()=>{ if(!uploadedURL) return alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ –º–µ–Ω—é'); imageURL = uploadedURL; imageId = 'uploaded:'+uploadedURL; messageEl.textContent='–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞.'; });
menuCreate.addEventListener('click', ()=>{
  const c = Math.max(1, Math.min(30, +menuCols.value || 1)); const r = Math.max(1, Math.min(30, +menuRows.value || 1));
  if(!imageURL) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ –º–µ–Ω—é.');
  createPuzzle(imageURL, imageId, c, r);
  closeMenu();
});

/* --------- Puzzle creation & basic UI --------- */
function createPuzzle(imgSrc, imgId, c, r){
  cols = c; rows = r;
  const canvasSize = 500; pieceWidth = Math.floor(canvasSize/cols); pieceHeight = Math.floor(canvasSize/rows);
  puzzleEl.innerHTML = ''; cells=[]; pieceIdCounter=0; solvedAlready=false; selectedPiece=null;
  puzzleEl.style.gridTemplateColumns = `repeat(${cols}, ${pieceWidth}px)`; puzzleEl.style.gridTemplateRows = `repeat(${rows}, ${pieceHeight}px)`;
  for(let i=0;i<cols*rows;i++){
    const cell = document.createElement('div'); cell.className='cell'; cell.style.width=pieceWidth+'px'; cell.style.height=pieceHeight+'px'; cell.dataset.index = i;
    cell.addEventListener('dragover', e=>{ e.preventDefault(); cell.classList.add('drop-target'); });
    cell.addEventListener('dragleave', ()=>cell.classList.remove('drop-target'));
    cell.addEventListener('drop', onDropOnCell);

    const piece = document.createElement('div'); piece.className='piece'; piece.draggable=true; piece.id='piece-'+(pieceIdCounter++);
    const rr=Math.floor(i/cols), cc=i%cols;
    piece.style.backgroundImage = `url(${imgSrc})`; piece.style.backgroundSize = `${cols*pieceWidth}px ${rows*pieceHeight}px`; piece.style.backgroundPosition = `-${cc*pieceWidth}px -${rr*pieceHeight}px`;
    piece.dataset.correct = i;

    piece.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', piece.id); piece.classList.add('dragging'); if(!started) startTimer(); });
    piece.addEventListener('dragend', ()=>{ piece.classList.remove('dragging'); document.querySelectorAll('.cell.drop-target').forEach(el=>el.classList.remove('drop-target')); });

    piece.addEventListener('click', e=>{ e.stopPropagation(); toggleSelect(piece); });

    piece.addEventListener('touchstart', onTouchStart, {passive:false});
    piece.addEventListener('touchmove', onTouchMove, {passive:false});
    piece.addEventListener('touchend', onTouchEnd);

    cell.appendChild(piece); cells.push(cell); puzzleEl.appendChild(cell);
  }
  currentPuzzleMeta = { imageId: imgId, imageURL: imgSrc, cols: cols, rows: rows };
  shuffle(); shuffleBtn.disabled=false; resetTimer(); previewContainer.style.display='none'; previewPuzzle.innerHTML=''; messageEl.textContent='–ü–∞–∑–ª —Å–æ–∑–¥–∞–Ω. –ù–∞—á–∏–Ω–∞–π—Ç–µ!';
}

/* shuffle & handlers */
shuffleBtn.addEventListener('click', ()=>{ shuffle(); solvedAlready=false; hideComplete(); resetTimer(); messageEl.textContent='–ü–∞–∑–ª –ø–µ—Ä–µ–º–µ—à–∞–Ω'; });
function shuffle(){ if(!cells.length) return; const pieces = cells.map(c=>c.firstChild); for(let i=pieces.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [pieces[i],pieces[j]]=[pieces[j],pieces[i]]; } cells.forEach((cell,i)=>cell.appendChild(pieces[i])); document.querySelectorAll('.piece').forEach(p=>p.style.border='2px solid transparent'); }

function onDropOnCell(e){ e.preventDefault(); this.classList.remove('drop-target'); const id = e.dataTransfer.getData('text/plain'); const dragged = document.getElementById(id); if(!dragged) return; const targetPiece = this.firstChild; const sourceCell = dragged.parentElement; if(sourceCell===this) return; sourceCell.appendChild(targetPiece); this.appendChild(dragged); dragged.classList.remove('selected','dragging'); if(enableCheckEl.checked) checkPositions(); else if(isSolved()) finishPuzzle(); }

function toggleSelect(piece){ if(selectedPiece) selectedPiece.classList.remove('selected'); if(selectedPiece===piece){ selectedPiece=null; } else { selectedPiece=piece; piece.classList.add('selected'); } if(!started && selectedPiece) startTimer(); }
puzzleEl.addEventListener('click', e=>{ const cell = e.target.closest('.cell'); if(!cell || !selectedPiece) return; const targetPiece = cell.firstChild; const sourceCell = selectedPiece.parentElement; if(targetPiece===selectedPiece) return; sourceCell.appendChild(targetPiece); cell.appendChild(selectedPiece); selectedPiece.classList.remove('selected'); selectedPiece=null; if(enableCheckEl.checked) checkPositions(); else if(isSolved()) finishPuzzle(); });

function checkPositions(){ if(!cells.length) return; let solved=true; cells.forEach((cell,i)=>{ const piece=cell.firstChild; if(+piece.dataset.correct===i) piece.style.border='2px solid green'; else { piece.style.border='2px solid red'; solved=false; } }); if(solved) finishPuzzle(); }
function isSolved(){ return cells.length && cells.every((cell,i)=> +cell.firstChild.dataset.correct === i); }

/* complete overlay */
function finishPuzzle(){ if(solvedAlready) return; solvedAlready=true; stopTimer(); messageEl.textContent='–ü–∞–∑–ª —Å–æ–±—Ä–∞–Ω! üéâ'; const elapsedMs = (startTime ? Math.round(performance.now()-startTime) : 0); completeTime.textContent = '–í—Ä–µ–º—è: ' + formatTime(elapsedMs); showComplete(); // save to user if logged in
  const u = getCurrentUser(); if(u && currentPuzzleMeta){ saveResultForUser(u.email, { imageId: currentPuzzleMeta.imageId, imageURL: currentPuzzleMeta.imageURL, cols: currentPuzzleMeta.cols, rows: currentPuzzleMeta.rows, timeMs: elapsedMs, date: new Date().toISOString() }); }
}
function showComplete(){ $('completeOverlay').style.display='flex'; $('completeOverlay').setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
function hideComplete(){ $('completeOverlay').style.display='none'; $('completeOverlay').setAttribute('aria-hidden','true'); document.body.style.overflow=''; }
completeShuffle.addEventListener('click', ()=>{ hideComplete(); shuffle(); resetTimer(); solvedAlready=false; messageEl.textContent='–ü–∞–∑–ª –ø–µ—Ä–µ–º–µ—à–∞–Ω'; });
completeNew.addEventListener('click', ()=>{ hideComplete(); openMenu(); });
completeClose.addEventListener('click', ()=>{ hideComplete(); });

/* timer */
function startTimer(){ if(started) return; started=true; startTime = performance.now(); timer = setInterval(()=>{ const t = Math.round(performance.now()-startTime); timerDisplay.textContent = '–í—Ä–µ–º—è: ' + formatTime(t); }, 50); }
function stopTimer(){ clearInterval(timer); }
function resetTimer(){ clearInterval(timer); started=false; startTime=null; timerDisplay.textContent='–í—Ä–µ–º—è: 0:00:000'; }

/* preview assembled */
previewBtn.addEventListener('click', ()=>{
  const meta = currentPuzzleMeta;
  const img = (meta && meta.imageURL) || imageURL;
  if(!img) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ –º–µ–Ω—é.');
  if(previewContainer.style.display==='block'){ previewContainer.style.display='none'; previewBtn.textContent='–ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É'; return; }
  const useCols = (meta && meta.cols) || cols; const useRows = (meta && meta.rows) || rows;
  const canvasSize = 500; const pW=Math.floor(canvasSize/useCols), pH=Math.floor(canvasSize/useRows);
  previewPuzzle.innerHTML=''; previewPuzzle.style.gridTemplateColumns = `repeat(${useCols}, ${pW}px)`; previewPuzzle.style.gridTemplateRows = `repeat(${useRows}, ${pH}px)`;
  for(let i=0;i<useCols*useRows;i++){ const r=Math.floor(i/useCols), c=i%useCols; const pp=document.createElement('div'); pp.className='previewPiece'; pp.style.width=pW+'px'; pp.style.height=pH+'px'; pp.style.backgroundImage=`url(${img})`; pp.style.backgroundSize = `${useCols*pW}px ${useRows*pH}px`; pp.style.backgroundPosition = `-${c*pW}px -${r*pH}px`; previewPuzzle.appendChild(pp); }
  previewContainer.style.display='block'; previewBtn.textContent='–°–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É';
});

/* touch support */
let touchDrag = { piece:null, srcCell:null, currentTargetCell:null };
function onTouchStart(e){ e.preventDefault(); const piece = e.currentTarget; touchDrag.piece=piece; touchDrag.srcCell=piece.parentElement; piece.classList.add('dragging'); if(!started) startTimer(); }
function onTouchMove(e){ if(!touchDrag.piece) return; e.preventDefault(); const t = e.changedTouches[0]; const el = document.elementFromPoint(t.clientX, t.clientY); const cell = el ? el.closest('.cell') : null; if(cell !== touchDrag.currentTargetCell){ if(touchDrag.currentTargetCell) touchDrag.currentTargetCell.classList.remove('drop-target'); touchDrag.currentTargetCell = cell; if(cell) cell.classList.add('drop-target'); } }
function onTouchEnd(e){ if(!touchDrag.piece) return; const piece = touchDrag.piece; const targetCell = touchDrag.currentTargetCell; piece.classList.remove('dragging'); if(targetCell && targetCell !== touchDrag.srcCell){ const targetPiece = targetCell.firstChild; const srcCell = touchDrag.srcCell; srcCell.appendChild(targetPiece); targetCell.appendChild(piece); if(enableCheckEl.checked) checkPositions(); else if(isSolved()) finishPuzzle(); } document.querySelectorAll('.cell.drop-target').forEach(el=>el.classList.remove('drop-target')); touchDrag.piece=null; touchDrag.srcCell=null; touchDrag.currentTargetCell=null; }

/* --------- Accounts: demo client-side system with avatar storage --------- */
function loadUsers(){ try{ return JSON.parse(localStorage.getItem(STORAGE_USERS) || '{}'); }catch(e){ return {}; } }
function saveUsers(users){ localStorage.setItem(STORAGE_USERS, JSON.stringify(users)); }
function setCurrentUser(e){ if(e) localStorage.setItem(STORAGE_CURRENT, e); else localStorage.removeItem(STORAGE_CURRENT); }
function getCurrentUserEmail(){ return localStorage.getItem(STORAGE_CURRENT); }
function getCurrentUser(){ const e=getCurrentUserEmail(); if(!e) return null; const u = loadUsers()[e]; return u || null; }

function genCode(){ return Math.floor(100000 + Math.random()*900000).toString(); }

async function registerUser(email, nick, age, password, avatarDataUrl){
  const users = loadUsers();
  if(users[email]) return { ok:false, msg:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —ç—Ç–æ–π –ø–æ—á—Ç–æ–π —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.' };
  const pwHash = await sha256Hex(password);
  const code = genCode();
  users[email] = { email, nick, age:+age, pwHash, confirmed:false, confirmationCode:code, stats:[], avatar: avatarDataUrl || null };
  saveUsers(users);
  return { ok:true, code };
}

function confirmUser(email, code){
  const users = loadUsers(); const u = users[email]; if(!u) return { ok:false, msg:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.' };
  if(u.confirmed) return { ok:false, msg:'–£–∂–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω.' };
  if(u.confirmationCode === code){ u.confirmed = true; delete u.confirmationCode; saveUsers(users); return { ok:true }; }
  return { ok:false, msg:'–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥.' };
}

async function loginUser(email, password){
  const users = loadUsers(); const u = users[email];
  if(!u) return { ok:false, msg:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.' };
  const h = await sha256Hex(password);
  if(h !== u.pwHash) return { ok:false, msg:'–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å.' };
  if(!u.confirmed) return { ok:false, msg:'–ü–æ—á—Ç–∞ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∫–æ–¥.' };
  setCurrentUser(email);
  return { ok:true, user:u };
}

function logoutUser(){ setCurrentUser(null); updateAccountButton(); }

function resendConfirmation(email){
  const users = loadUsers(); const u = users[email]; if(!u) return { ok:false, msg:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.' };
  if(u.confirmed) return { ok:false, msg:'–£–∂–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω.' };
  const code = genCode(); u.confirmationCode = code; saveUsers(users); return { ok:true, code };
}

function saveResultForUser(email, result){
  const users = loadUsers(); const u = users[email]; if(!u) return false;
  u.stats = u.stats || []; u.stats.push(result); saveUsers(users); return true;
}

/* --------- Account UI logic --------- */
function showTab(tab){
  ['tabLogin','tabRegister','tabProfile','tabStats'].forEach(id=>$(id).classList.remove('active'));
  ['paneLogin','paneRegister','paneProfile','paneStats'].forEach(id=>$(id).style.display='none');
  if(tab==='login'){ $('tabLogin').classList.add('active'); $('paneLogin').style.display='block'; }
  if(tab==='register'){ $('tabRegister').classList.add('active'); $('paneRegister').style.display='block'; }
  if(tab==='profile'){ $('tabProfile').classList.add('active'); $('paneProfile').style.display='block'; updateProfilePane(); }
  if(tab==='stats'){ $('tabStats').classList.add('active'); $('paneStats').style.display='block'; updateStatsPane(); }
}

$('goToRegister').addEventListener('click', ()=> showTab('register') );

/* open/close account overlay */
function openAccount(){ accountOverlay.style.display='flex'; accountOverlay.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; showTab(getCurrentUser()? 'profile':'login'); updateAccountButton(); }
function closeAccount(){ accountOverlay.style.display='none'; accountOverlay.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }
accountBtn.addEventListener('click', ()=> accountOverlay.style.display==='flex' ? closeAccount() : openAccount() );
accountClose.addEventListener('click', closeAccount);
accountOverlay.addEventListener('click', e=>{ if(e.target===accountOverlay) closeAccount(); });

/* Registration with avatar read */
regAvatar.addEventListener('change', e=>{
  const f = e.target.files && e.target.files[0]; if(!f){ regAvatarPreview.style.display='none'; regAvatarPreview.src=''; return; }
  const reader = new FileReader();
  reader.onload = ()=>{ regAvatarPreview.src = reader.result; regAvatarPreview.style.display='block'; };
  reader.readAsDataURL(f);
});

regBtn.addEventListener('click', async ()=>{
  const email = regEmail.value.trim().toLowerCase(); const nick = regNick.value.trim(); const age = regAge.value; const pw = regPassword.value; const pw2 = regPassword2.value;
  regMsg.style.color='var(--muted)';
  if(!email||!nick||!age||!pw||!pw2){ regMsg.textContent='–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è.'; return; }
  if(pw !== pw2){ regMsg.textContent='–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç.'; return; }
  if(pw.length < 6){ regMsg.textContent='–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤.'; return; }

  // read avatar if present
  let avatarDataUrl = null;
  const f = regAvatar.files && regAvatar.files[0];
  if(f){
    avatarDataUrl = await new Promise(resolve=>{
      const reader = new FileReader(); reader.onload = ()=>resolve(reader.result); reader.readAsDataURL(f);
    });
  }

  const res = await registerUser(email, nick, age, pw, avatarDataUrl);
  if(!res.ok){ regMsg.style.color='var(--danger)'; regMsg.textContent = res.msg; return; }
  regMsg.style.color='#228822';
  regMsg.textContent = `–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ. –ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–¥–µ–º–æ): ${res.code}. –í–æ–π–¥–∏—Ç–µ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.`;
  // fill login email
  loginEmail.value = email;
});

regCancel.addEventListener('click', ()=> { regEmail.value=''; regNick.value=''; regAge.value=''; regPassword.value=''; regPassword2.value=''; regAvatar.value=''; regAvatarPreview.style.display='none'; regMsg.textContent=''; showTab('login'); });

/* Login */
loginBtn.addEventListener('click', async ()=>{
  const email = loginEmail.value.trim().toLowerCase(); const pw = loginPassword.value || '';
  loginMsg.style.color='var(--muted)';
  if(!email||!pw){ loginMsg.textContent='–í–≤–µ–¥–∏—Ç–µ –ø–æ—á—Ç—É –∏ –ø–∞—Ä–æ–ª—å.'; return; }
  const res = await loginUser(email, pw);
  if(!res.ok){ loginMsg.style.color='var(--danger)'; loginMsg.textContent = res.msg; return; }
  loginMsg.style.color='#228822'; loginMsg.textContent='–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω.';
  updateAccountButton(); showTab('profile'); updateProfilePane();
});

/* Profile pane and avatar change */
function updateAccountButton(){
  const u = getCurrentUser();
  if(u && u.avatar){
    accountBtn.innerHTML = `<img src="${u.avatar}" class="avatar-small" alt="–ê–≤–∞—Ç–∞—Ä"> ${u.nick || '–ê–∫–∫–∞—É–Ω—Ç'}`;
  } else if(u){
    accountBtn.innerHTML = `<img src="" class="avatar-small" style="display:none"> ${u.nick || '–ê–∫–∫–∞—É–Ω—Ç'}`;
  } else {
    accountBtn.innerHTML = '–ê–∫–∫–∞—É–Ω—Ç';
  }
}

function updateProfilePane(){
  const u = getCurrentUser();
  if(!u){ profileInfo.innerHTML = '<em>–í—ã –Ω–µ –≤–æ—à–ª–∏. –í–æ–π–¥–∏—Ç–µ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å.</em>'; profileAvatarImg.style.display='none'; profileMsg.textContent=''; return; }
  profileInfo.innerHTML = `<strong>${u.nick}</strong><br>–ü–æ—á—Ç–∞: ${u.email}<br>–í–æ–∑—Ä–∞—Å—Ç: ${u.age}<br>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞: ${u.confirmed ? '–¥–∞' : '–Ω–µ—Ç'}`;
  if(u.avatar){ profileAvatarImg.src = u.avatar; profileAvatarImg.style.display='block'; } else { profileAvatarImg.style.display='none'; profileAvatarImg.src=''; }
  profileMsg.textContent = '';
}

profileAvatarInput.addEventListener('change', e=>{
  const f = e.target.files && e.target.files[0]; if(!f) return;
  const reader = new FileReader(); reader.onload = ()=>{ profileAvatarImg.src = reader.result; profileAvatarImg.style.display='block'; };
  reader.readAsDataURL(f);
});

saveAvatarBtn.addEventListener('click', ()=>{
  const u = getCurrentUser(); if(!u){ profileMsg.textContent='–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä.'; return; }
  // if file selected, save it
  const f = profileAvatarInput.files && profileAvatarInput.files[0];
  if(!f){ profileMsg.textContent='–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.'; return; }
  const reader = new FileReader();
  reader.onload = ()=>{ const dataUrl = reader.result; const users = loadUsers(); users[u.email].avatar = dataUrl; saveUsers(users); profileMsg.style.color='#228822'; profileMsg.textContent='–ê–≤–∞—Ç–∞—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω.'; updateAccountButton(); updateProfilePane(); };
  reader.readAsDataURL(f);
});

logoutBtn.addEventListener('click', ()=>{ logoutUser(); updateAccountButton(); showTab('login'); profileMsg.textContent='–í—ã –≤—ã—à–ª–∏.'; });

confirmCodeBtn.addEventListener('click', ()=>{
  const code = confirmCodeInput.value.trim(); const u = getCurrentUser();
  if(!u){ profileMsg.style.color='var(--danger)'; profileMsg.textContent='–í–æ–π–¥–∏—Ç–µ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.'; return; }
  const res = confirmUser(u.email, code);
  if(res.ok){ profileMsg.style.color='#228822'; profileMsg.textContent='–ü–æ—á—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞.'; updateProfilePane(); updateAccountButton(); } else { profileMsg.style.color='var(--danger)'; profileMsg.textContent = res.msg; }
});

/* Stats UI */
function updateStatsPane(){
  const u = getCurrentUser();
  if(!u){ $('statsSummary').textContent='–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.'; statsTableBody.innerHTML=''; return; }
  const stats = u.stats || []; $('statsSummary').textContent = `–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: ${stats.length}`;
  const rows = (stats.slice().reverse()).map(s=>{
    const img = s.imageId && s.imageId.startsWith('uploaded:') ? '–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ' : (presets.find(p=>p.id===s.imageId)?.title || s.imageId || '–ö–∞—Ä—Ç–∏–Ω–∫–∞');
    return `<tr><td>${img}</td><td>${s.cols}√ó${s.rows}</td><td>${formatTime(s.timeMs)}</td><td>${new Date(s.date).toLocaleString()}</td></tr>`;
  }).join('');
  statsTableBody.innerHTML = rows;
}

/* Resend confirmation: show code (demo) */
function resendConfirmationForCurrentUser(){
  const u = getCurrentUser(); if(!u){ profileMsg.textContent='–í–æ–π–¥–∏—Ç–µ.'; return; }
  const res = resendConfirmation(u.email);
  if(res.ok){ profileMsg.style.color='#228822'; profileMsg.textContent = `–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–¥–µ–º–æ): ${res.code}`; } else { profileMsg.style.color='var(--danger)'; profileMsg.textContent = res.msg; }
}

/* hook up simple handlers for complete overlay & menu */
$('menuToggleBtn').addEventListener('click', ()=> menuOverlay.style.display==='flex' ? closeMenu() : openMenu() );
$('menuClose').addEventListener('click', closeMenu);
$('menuUpload').addEventListener('change', e=>{ const f=e.target.files&&e.target.files[0]; if(!f) return; if(uploadedURL) URL.revokeObjectURL(uploadedURL); uploadedURL = URL.createObjectURL(f); imageURL=uploadedURL; imageId='uploaded:'+uploadedURL; document.querySelectorAll('.presetItem').forEach(i=>i.style.border='none'); });

$('completeOverlay').style.display='none'; $('menuOverlay').style.display='none'; $('accountOverlay').style.display='none';

/* account overlay toggles */
$('accountBtn').addEventListener('click', ()=> accountOverlay.style.display==='flex' ? closeAccount() : openAccount() );

/* login default behavior */
loginBtn.addEventListener('click', async ()=>{ /* handled above */ });

/* small wiring for menu preset thumbnails created earlier */
buildPresetThumbnails();

/* ensure account button reflects current user on load */
updateAccountButton();

/* ESC to close overlays */
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ if(menuOverlay.style.display==='flex') closeMenu(); if(accountOverlay.style.display==='flex') closeAccount(); if(completeOverlay.style.display==='flex') hideComplete(); } });

/* on page load, attach handlers to ids that we referenced earlier but not created as elements variables */
$('completeOverlay').addEventListener('click', e=>{ if(e.target === $('completeOverlay')) hideComplete(); });
$('menuOverlay').addEventListener('click', e=>{ if(e.target === $('menuOverlay')) closeMenu(); });
accountOverlay.addEventListener('click', e=>{ if(e.target === accountOverlay) closeAccount(); });

/* initial message */
messageEl.textContent = '–ù–∞–∂–º–∏—Ç–µ "–ú–µ–Ω—é", —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É –∏ —Ä–∞–∑–º–µ—Ä. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.';
</script>

</body>
</html>
